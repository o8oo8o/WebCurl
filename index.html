<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>WebCurl</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            min-width: 800px;
            margin: 0 auto;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow-x: auto;
        }

        .request-section {
            margin-bottom: 20px;
        }

        .url-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        select,
        input,
        textarea,
        button {
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        select {
            width: 100px;
            background: #ffffff;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        input[type="url"] {
            flex: 1;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: linear-gradient(135deg, #b2bec3 0%, #636e72 100%);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .loading {
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .send-btn-group {
            display: flex;
            position: relative;
        }

        .send-btn-group #sendBtn {
            border-radius: 10px 0 0 10px;
            padding: 10px 20px;
        }

        .send-btn-dropdown {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0 10px 10px 0;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 10px;
            min-width: 32px;
        }

        .send-btn-dropdown:hover {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
        }

        .send-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 120px;
            overflow: hidden;
        }

        .send-dropdown-menu.show {
            display: block;
        }

        .send-dropdown-menu div {
            padding: 12px 16px;
            cursor: pointer;
            color: #2d3436;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .send-dropdown-menu div:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .send-btn-group.loading-group .send-btn-dropdown {
            display: none;
        }

        .send-btn-group.loading-group #sendBtn {
            border-radius: 10px;
        }

        .request-tabs,
        .response-tabs,
        .panel-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 15px;
            gap: 4px;
        }

        .request-tab,
        .response-tab {
            padding: 4px 6px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 5px 5px 0 0;
            background: #f8f9fa;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .request-tab:hover,
        .response-tab:hover {
            background: #e9ecef;
        }

        .request-tab.active,
        .response-tab.active {
            border: 2px solid #667eea;
            border-bottom: 1px solid #ffffff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
            min-height: 300px;
        }

        .tab-content.active,
        .response-tab-content.active,
        .panel-content.active {
            display: block;
        }

        .header-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #667eea;
        }

        .header-row input[type="text"] {
            flex: 1;
        }

        .remove-btn {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3) !important;
        }

        .remove-btn:hover {
            box-shadow: 0 6px 20px rgba(214, 48, 49, 0.4) !important;
        }

        .response-section {
            margin-top: 20px;
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
        }

        .response-info {
            margin-bottom: 15px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .response-tab-content {
            display: none;
            padding: 15px 0;
        }

        #responseBody {
            width: 100%;
            min-height: 200px;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            white-space: pre-wrap;
            background: #fafbfc;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            line-height: 1.6;
        }

        .file-input-container {
            margin-top: 10px;
        }

        .headers-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            border-radius: 10px;
            overflow: hidden;
        }

        .headers-table th,
        .headers-table td {
            border: 1px solid #e9ecef;
            padding: 12px;
            text-align: left;
        }

        .headers-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .headers-table tr:hover td {
            background: #f8f9fa;
        }

        .formdata-row,
        .body-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: start;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            width: 100%;
        }

        .formdata-row input[type="checkbox"],
        .body-row input[type="radio"] {
            width: 18px;
            height: 18px;
            margin: 0;
            margin-top: 10px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .formdata-key {
            width: 30%;
            min-width: 200px;
        }

        .formdata-type {
            width: 15%;
            min-width: 120px;
        }

        .formdata-value {
            flex: 1;
            min-width: 200px;
        }

        .formdata-value .text-input {
            width: 100%;
            height: 40px;
        }

        .formdata-value .file-input {
            width: 100%;
            height: 40px;
            padding: 6px;
            box-sizing: border-box;
        }

        .formdata-value .file-input::-webkit-file-upload-button {
            height: 26px;
            padding: 0 12px;
            margin-right: 10px;
            border: 2px solid #e9ecef;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .file-preview {
            margin-top: 5px;
            font-size: 12px;
            color: #636e72;
        }

        .file-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 10px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .btn-action,
        .history-load-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 8px !important;
            cursor: pointer;
            font-size: 12px !important;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3) !important;
            margin-top: 10px;
            height: auto;
            white-space: nowrap;
        }

        .btn-action:hover,
        .history-load-btn:hover {
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.4) !important;
            transform: translateY(-2px);
        }

        .btn-danger-action {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 8px !important;
            cursor: pointer;
            font-size: 12px !important;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3) !important;
            margin-top: 10px;
            height: auto;
            white-space: nowrap;
        }

        .btn-danger-action:hover {
            box-shadow: 0 6px 20px rgba(214, 48, 49, 0.4) !important;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636e72 0%, #2d3436 100%) !important;
            box-shadow: 0 4px 15px rgba(45, 52, 54, 0.3) !important;
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(45, 52, 54, 0.4) !important;
        }

        .container-hidden {
            display: none;
        }

        .container-margin-top {
            margin-top: 10px;
        }

        .input-remark {
            width: 80px;
        }

        .input-ws-send {
            width: 60%;
        }

        .table-col-enable {
            width: 40px;
        }

        .table-col-action {
            width: 55px;
        }

        .textarea-body,
        .body-content textarea {
            width: 100%;
            height: 150px;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            resize: vertical;
            background: #fafbfc;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        .file-input-binary {
            width: 100%;
            height: 40px;
            padding: 6px;
            box-sizing: border-box;
        }

        .file-input-ws {
            display: none;
            width: 180px;
        }

        .select-formdata-type {
            width: 30px;
        }

        .divider {
            margin: 15px 0;
            border: none;
            border-top: 2px solid #e9ecef;
        }

        .setting-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        .setting-input-integrity {
            display: none;
            width: 100%;
            margin-top: 5px;
        }

        .collection-selector {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collection-selector select {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        .form-remark {
            width: 80px;
        }

        .body-type-radio {
            display: inline-flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .body-type-radio label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .body-type-radio label:hover {
            background: #e9ecef;
        }

        .body-type-radio label:has(input:checked) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .body-type-radio input[type="radio"] {
            cursor: pointer;
            accent-color: #667eea;
            width: 14px;
            height: 14px;
        }

        #bodyTab {
            position: relative;
            width: 100%;
        }

        #formContainer,
        #formDataContainer {
            width: 100%;
        }

        .content-wrapper {
            display: flex;
            gap: 16px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .content-wrapper-expanded {
            max-width: 100%;
            justify-content: center;
            padding: 0 16px;
        }

        .aside {
            width: 30%;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-height: calc(100vh - 32px);
            overflow-y: scroll;
        }

        .aside::-webkit-scrollbar {
            width: 8px;
        }

        .aside::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }

        .aside::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .aside-hidden {
            display: none;
        }

        .toggle-aside-btn {
            padding: 10px 12px;
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .toggle-aside-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        .global-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .global-actions button {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-size: 12px;
            min-width: 70px;
        }

        .panel-tab {
            padding: 4px 6px;
            cursor: pointer;
            border: 1px solid transparent;
            flex: 1;
            text-align: center;
            border-radius: 5px 5px 0 0;
            background: #f8f9fa;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .panel-tab:hover {
            background: #e9ecef;
        }

        .panel-tab.active {
            border: 2px solid #667eea;
            border-bottom: 2px solid #ffffff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: -1px;
        }

        .panel-content {
            display: none;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-header .btn-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .history-item {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 13px;
            position: relative;
            background: #fafbfc;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #667eea;
        }

        .history-method {
            font-weight: bold;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 8px;
        }

        .history-url {
            color: #636e72;
            word-break: break-all;
            margin-bottom: 5px;
        }

        .history-time {
            font-size: 12px;
            color: #b2bec3;
            margin-bottom: 5px;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        .main-content-expanded {
            width: 100%;
            max-width: 1400px;
            flex: none;
            margin: 0 auto;
        }

        .settings-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        .settings-dialog h3 {
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 12px;
            color: #2d3436;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2d3436;
        }

        .settings-group select {
            width: 100%;
            margin-bottom: 10px;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .history-item button {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            height: 28px;
            color: white;
            margin: 2px;
        }

        .variables-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            border-radius: 10px;
            overflow: hidden;
        }

        .variables-table th,
        .variables-table td {
            border: 1px solid #e9ecef;
            padding: 4px 6px;
            text-align: left;
        }

        .variables-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .variables-table td {
            font-size: 12px;
        }

        .variables-table input[type="text"] {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 12px;
            background: transparent;
        }

        .variables-table input[type="text"]:focus {
            border-color: #667eea;
            background: #ffffff;
            outline: none;
        }

        .variables-table input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #667eea;
        }

        .variables-table .remove-btn {
            padding: 3px 8px;
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .variables-table .remove-btn:hover {
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3) !important;
        }

        .variables-table-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .variables-table-container .btn-action,
        .variables-table-container .btn-danger-action {
            padding: 5px 12px !important;
            font-size: 12px !important;
            height: auto !important;
        }

        .body-content {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .body-content input[type="file"] {
            width: 100%;
            height: 40px;
            padding: 6px;
            box-sizing: border-box;
        }

        .json-body-formatted {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }

        .body-remark {
            width: 120px;
            min-width: 120px;
            height: 150px;
            resize: vertical;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            background: #fafbfc;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        .body-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .body-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }

        .json-body-formatted::-webkit-scrollbar {
            width: 6px;
        }

        .json-body-formatted::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 3px;
        }

        .json-body-formatted::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }

        .json-formatted {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #dfe6e9;
            padding: 16px;
            border-radius: 10px;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            white-space: pre;
            border: 2px solid #2d3436;
            max-height: 400px;
            overflow-y: auto;
        }

        .json-formatted::-webkit-scrollbar {
            width: 8px;
        }

        .json-formatted::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 4px;
        }

        .json-formatted::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .json-formatted .json-key {
            color: #74b9ff;
        }

        .json-formatted .json-string {
            color: #55efc4;
        }

        .json-formatted .json-number {
            color: #ffeaa7;
        }

        .json-formatted .json-boolean,
        .json-formatted .json-null {
            color: #fd79a8;
        }

        .json-formatted .json-bracket {
            color: #dfe6e9;
        }

        .json-formatted .json-arrow {
            cursor: pointer;
            user-select: none;
            color: #74b9ff;
            margin-right: 6px;
            transition: all 0.2s ease;
        }

        .json-formatted .json-arrow:hover {
            color: #0984e3;
        }

        .json-formatted .json-container {
            margin-left: 20px;
            border-left: 2px solid #667eea;
            padding-left: 12px;
        }

        #wsBodyContainer {
            width: 100%;
        }

        #wsBodyRows .body-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            width: 100%;
        }

        #wsBodyRows .body-row input[type="radio"] {
            width: 18px;
            accent-color: #667eea;
        }

        #wsBodyRows .ws-body-type {
            min-width: 180px;
            max-width: 200px;
        }

        #wsBodyRows .ws-body-content {
            flex: 1;
            width: 100%;
        }

        #wsBodyRows .ws-body-text {
            width: 100%;
            min-height: 40px;
            resize: vertical;
            background: #fafbfc;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        #wsBodyRows .ws-body-file {
            width: 100%;
        }

        #wsBodyRows .body-remark {
            min-width: 120px;
            max-width: 200px;
            flex: 0 0 160px;
            height: 40px;
            resize: vertical;
            background: #fafbfc;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        #wsBodyRows .remove-btn {
            min-width: 60px;
        }

        #wsBodyContainer .ws-body-actions {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-top: 8px;
        }

        #wsBodyContainer .ws-body-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        select option {
            min-height: 32px;
            padding: 8px 10px;
            font-size: 15px;
        }

        .httpStatus1 {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
            color: #ffffff !important;
        }

        .httpStatus2 {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%) !important;
            color: #ffffff !important;
        }

        .httpStatus3 {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%) !important;
            color: #2d3436 !important;
        }

        .httpStatus4 {
            background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%) !important;
            color: #ffffff !important;
        }

        .httpStatus5 {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
            color: #ffffff !important;
        }

        .new-request-btn {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%) !important;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3) !important;
        }

        .new-request-btn:hover {
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4) !important;
        }

        .response-actions {
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .response-actions button {
            padding: 8px 14px;
            font-size: 13px;
        }

        .script-section {
            margin-bottom: 16px;
        }

        .script-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .script-section-title {
            font-weight: 600;
            color: #2d3436;
            font-size: 14px;
        }

        .script-action-btn {
            padding: 4px 12px !important;
            font-size: 12px !important;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.3) !important;
        }

        .script-action-btn:hover {
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4) !important;
            transform: translateY(-1px);
        }

        .script-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            background: #fafbfc;
            color: #2d3436;
            transition: all 0.3s ease;
        }

        .script-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: #ffffff;
        }

        .script-textarea::placeholder {
            color: #b2bec3;
        }

        /* ========== Hook脚本功能样式 ========== */

        /* Hook脚本区块容器 */
        .hook-section {
            margin-bottom: 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        /* Hook脚本区块头部 */
        .hook-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #e9ecef;
        }

        /* Hook脚本区块标题 */
        .hook-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #2d3436;
            font-size: 14px;
        }

        /* Hook启用复选框 */
        .hook-enable-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* Hook操作按钮容器 */
        .hook-actions {
            display: flex;
            gap: 6px;
        }

        /* Hook操作按钮样式 */
        .hook-action-btn {
            padding: 4px 10px !important;
            font-size: 11px !important;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(116, 185, 255, 0.3) !important;
        }

        .hook-action-btn:hover {
            box-shadow: 0 4px 10px rgba(116, 185, 255, 0.4) !important;
            transform: translateY(-1px);
        }

        /* Hook危险操作按钮（如清空） */
        .hook-action-btn.danger {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%) !important;
            box-shadow: 0 2px 6px rgba(214, 48, 49, 0.3) !important;
        }

        .hook-action-btn.danger:hover {
            box-shadow: 0 4px 10px rgba(214, 48, 49, 0.4) !important;
        }

        /* Hook脚本编辑文本框 */
        .hook-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: none;
            border-top: 1px solid #e9ecef;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            background: #fafbfc;
            color: #2d3436;
            transition: all 0.3s ease;
        }

        .hook-textarea:focus {
            outline: none;
            background: #ffffff;
        }

        .hook-textarea::placeholder {
            color: #b2bec3;
        }

        /* Hook控制台容器 */
        .hook-console {
            margin-top: 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        /* Hook控制台头部 */
        .hook-console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        /* Hook控制台清空按钮 */
        .hook-console-clear {
            padding: 2px 8px !important;
            font-size: 11px !important;
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer;
        }

        /* Hook控制台输出区域 */
        .hook-console-output {
            height: 120px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: "Fira Code", "JetBrains Mono", Consolas, monospace;
            font-size: 12px;
            line-height: 1.6;
            padding: 8px 12px;
        }

        /* Hook控制台日志行 */
        .hook-console-line {
            margin-bottom: 4px;
            word-break: break-all;
        }

        /* Hook控制台日志类型样式 */
        .hook-console-line.info {
            color: #74b9ff;
        }

        .hook-console-line.success {
            color: #00b894;
        }

        .hook-console-line.error {
            color: #ff7675;
        }

        .hook-console-line.warn {
            color: #fdcb6e;
        }

        /* Hook控制台时间戳 */
        .hook-console-time {
            color: #636e72;
            margin-right: 8px;
        }

        .hook-example-dropdown {
            position: relative;
            display: inline-block;
        }

        .hook-example-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 180px;
            overflow: hidden;
            margin-top: 4px;
        }

        .hook-example-menu.show {
            display: block;
        }

        .hook-example-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 12px;
            color: #2d3436;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .hook-example-item:last-child {
            border-bottom: none;
        }

        .hook-example-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>

<body>
    <div class="content-wrapper">
        <div class="aside">
            <div class="global-actions">
                <button class="btn-action" onclick="exportAllConfig()">导出配置</button>
                <button class="btn-action" onclick="importAllConfig()">导入配置</button>
                <button class="btn-action" onclick="openSettings()">请求配置</button>
                <button class="btn-action" onclick="window.open('/tool')">工具</button>
                <button class="btn-action" onclick="window.open('/mock')">Mock</button>
            </div>
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchPanelTab('history')">历史</div>
                <div class="panel-tab" onclick="switchPanelTab('apis')">接口</div>
                <div class="panel-tab" onclick="switchPanelTab('variables')">变量</div>
                <div class="panel-tab" onclick="switchPanelTab('globalHeaders')">全局头</div>
            </div>
            <div id="historyPanel" class="panel-content active">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="btn-danger-action" onclick="clearHistory()">清空</button>
                        <button class="btn-action" onclick="importHistory()">导入</button>
                        <button class="btn-action" onclick="exportHistory()">导出</button>
                    </div>
                </div>
                <div id="historyList"></div>
            </div>
            <div id="apisPanel" class="panel-content">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="btn-danger-action" onclick="clearApis()">清空</button>
                        <button class="btn-action" onclick="importApis()">导入</button>
                        <button class="btn-action" onclick="exportApis()">导出</button>
                        <button class="btn-action" onclick="addApiCollection()">新增</button>
                        <button class="btn-danger-action" onclick="removeApiCollection()">删除</button>
                    </div>
                </div>
                <!-- 集合管理UI -->
                <div class="collection-selector">
                    <label>集合:</label>
                    <select id="apiCollectionSelect" onchange="switchApiCollection()"></select>
                </div>
                <div id="apisList"></div>
            </div>
            <div id="variablesPanel" class="panel-content">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="btn-danger-action" onclick="clearVariables()">清空</button>
                        <button class="btn-action" onclick="importVariables()">导入</button>
                        <button class="btn-action" onclick="exportVariables()">导出</button>
                        <button class="btn-action" onclick="addVariableRow()">添加</button>
                        <button class="btn-action" onclick="saveVariables()">保存</button>
                    </div>
                </div>
                <div class="variables-table-container">
                    <table class="variables-table">
                        <thead>
                            <tr>
                                <th class="table-col-enable">启用</th>
                                <th>变量名</th>
                                <th>变量值</th>
                                <th class="table-col-action">操作</th>
                            </tr>
                        </thead>
                        <tbody id="variablesTableBody"></tbody>
                    </table>

                </div>
            </div>
            <div id="globalHeadersPanel" class="panel-content">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="btn-danger-action" onclick="clearGlobalHeaders()">清空</button>
                        <button class="btn-action" onclick="importGlobalHeaders()">导入</button>
                        <button class="btn-action" onclick="exportGlobalHeaders()">导出</button>
                        <button class="btn-action" onclick="addGlobalHeaderRow()">添加</button>
                        <button class="btn-action" onclick="saveGlobalHeaders()">保存</button>
                    </div>
                </div>
                <div class="variables-table-container">
                    <table class="variables-table">
                        <thead>
                            <tr>
                                <th class="table-col-enable">启用</th>
                                <th>请求头</th>
                                <th>请求值</th>
                                <th class="table-col-action">操作</th>
                            </tr>
                        </thead>
                        <tbody id="globalHeadersTableBody"></tbody>
                    </table>

                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="container">
                <div class="request-section">
                    <div class="url-section">
                        <button class="toggle-aside-btn" onclick="toggleAside()">◀</button>
                        <button class="new-request-btn" onclick="newRequest()">新建</button>
                        <select id="httpMethod">
                            <option>GET</option>
                            <option>POST</option>
                            <option>PUT</option>
                            <option>DELETE</option>
                            <option>PATCH</option>
                            <option>HEAD</option>
                            <option>OPTIONS</option>
                            <option>CONNECT</option>
                            <option>TRACE</option>
                            <option>WS</option>
                            <option>SSE</option>
                        </select>
                        <input type="url" id="url" placeholder="输入请求URL" value="" />
                        <button onclick="saveToApis()" class="btn-secondary">保存</button>
                        <div class="send-btn-group" id="sendBtnGroup">
                            <button id="sendBtn" onclick="handleSendButtonClick()">发送</button>
                            <button class="send-btn-dropdown" onclick="toggleSendDropdown(event)">▼</button>
                            <div class="send-dropdown-menu" id="sendDropdownMenu">
                                <div onclick="sendRequestAndDownload()">下载</div>
                            </div>
                        </div>
                    </div>

                    <div class="request-tabs">
                        <div class="request-tab active" onclick="switchRequestTab('headers')">请求头</div>
                        <div class="request-tab" onclick="switchRequestTab('body')">请求体</div>
                        <div class="request-tab" onclick="switchRequestTab('script')">脚本</div>
                        <div class="request-tab" onclick="switchRequestTab('tools')">工具</div>
                    </div>

                    <div id="headersTab" class="tab-content active">
                        <div id="headersList">
                            <div class="header-row">
                                <input type="checkbox" checked>
                                <input type="text" placeholder="Header名称" />
                                <input type="text" placeholder="Header值" />
                                <input type="text" placeholder="备注" class="header-remark input-remark" />
                                <button class="remove-btn" onclick="removeHeader(this)">删除</button>
                            </div>
                        </div>
                        <button onclick="addHeader()">添加请求头</button>
                    </div>

                    <div id="bodyTab" class="tab-content">
                        <div class="body-type-radio">
                            <label>
                                <input type="radio" name="bodyType" value="none" checked
                                    onchange="updateBodyType(this.value)">
                                <span>none</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="json" onchange="updateBodyType(this.value)">
                                <span>JSON</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="text" onchange="updateBodyType(this.value)">
                                <span>Text</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="binary"
                                    onchange="updateBodyType(this.value)">
                                <span>Binary</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="form" onchange="updateBodyType(this.value)">
                                <span>x-www-form-urlencoded</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="formdata"
                                    onchange="updateBodyType(this.value)">
                                <span>form-data</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="websocket"
                                    onchange="updateBodyType(this.value)">
                                <span>WebSocket</span>
                            </label>
                        </div>
                        <div id="jsonBodyContainer" class="container-hidden">
                            <div id="jsonBodyRows"></div>
                            <div class="body-actions">
                                <button class="btn-action" onclick="addJsonBodyRow()">添加JSON行</button>
                            </div>
                        </div>
                        <div id="textBodyContainer" class="container-hidden">
                            <div id="textBodyRows"></div>
                            <div class="body-actions">
                                <button class="btn-action" onclick="addTextBodyRow()">添加Text行</button>
                            </div>
                        </div>
                        <div id="binaryBodyContainer" class="container-hidden">
                            <div id="binaryBodyRows"></div>
                            <div class="body-actions">
                                <button class="btn-action" onclick="addBinaryBodyRow()">添加Binary行</button>
                            </div>
                        </div>
                        <div id="formDataContainer" class="file-input-container container-hidden">
                            <div id="formDataRows"></div>
                            <button class="btn-action" onclick="addFormDataRow()">添加新行</button>
                        </div>
                        <div id="formContainer" class="container-hidden container-margin-top">
                            <div id="formRows"></div>
                            <button onclick="addFormRow()" class="btn-action">添加表单项</button>
                        </div>
                        <div id="wsControls" class="container-hidden container-margin-top">
                            <input type="text" id="wsSendInput" placeholder="输入要发送的消息" class="input-ws-send">
                            <button id="wsSendBtn" class="btn-action">发送</button>
                            <button id="wsCloseBtn" class="btn-danger-action">关闭连接</button>
                        </div>
                        <div id="wsBodyContainer" class="container-hidden container-margin-top">
                            <div id="wsBodyRows"></div>
                            <div class="ws-body-actions">
                                <button class="btn-action" onclick="addWsBodyRow()" type="button">添加行</button>
                                <button class="btn-danger-action" onclick="if (currentWS) currentWS.close();"
                                    type="button">关闭连接</button>
                                <button class="btn-action" onclick="sendWsBody()" type="button">发送</button>
                            </div>
                        </div>
                    </div>

                    <div id="scriptTab" class="tab-content">
                        <div class="hook-section">
                            <div class="hook-section-header">
                                <div class="hook-section-title">
                                    <input type="checkbox" id="preRequestEnabled" class="hook-enable-checkbox" checked>
                                    <span>Pre-Request Hook（前置脚本）</span>
                                </div>
                                <div class="hook-actions">
                                    <div class="hook-example-dropdown">
                                        <button class="hook-action-btn" onclick="toggleHookExampleMenu('preRequest')">示例
                                            ▼</button>
                                        <div id="preRequestExampleMenu" class="hook-example-menu">
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('preRequest', 'sign')">动态签名</div>
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('preRequest', 'timestamp')">添加时间戳</div>
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('preRequest', 'auth')">动态Token</div>
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('preRequest', 'env')">环境切换</div>
                                        </div>
                                    </div>
                                    <button class="hook-action-btn danger"
                                        onclick="clearHookScript('preRequest')">清空</button>
                                </div>
                            </div>
                            <textarea id="preRequestScript" class="hook-textarea" placeholder="// 在请求发送前执行，可修改请求参数
function preRequest(request) {
    console.log(request)
    const utils = request.utils;
    console.log(utils.getAllVariables());
    console.log(utils.getAllGlobalHeaders());
    const timestamp = Date.now();
    request.headers['X-Timestamp'] = `${Date.now()}`;
    request.utils.log('已添加时间戳:', timestamp);
    return request;
}"></textarea>
                        </div>

                        <div class="hook-section">
                            <div class="hook-section-header">
                                <div class="hook-section-title">
                                    <input type="checkbox" id="postResponseEnabled" class="hook-enable-checkbox"
                                        checked>
                                    <span>Post-Response Hook（后置脚本）</span>
                                </div>
                                <div class="hook-actions">
                                    <div class="hook-example-dropdown">
                                        <button class="hook-action-btn"
                                            onclick="toggleHookExampleMenu('postResponse')">示例 ▼</button>
                                        <div id="postResponseExampleMenu" class="hook-example-menu">
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('postResponse', 'extractToken')">提取Token</div>
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('postResponse', 'log')">日志记录</div>
                                            <div class="hook-example-item"
                                                onclick="loadHookExample('postResponse', 'autoSave')">自动保存变量</div>
                                        </div>
                                    </div>
                                    <button class="hook-action-btn danger"
                                        onclick="clearHookScript('postResponse')">清空</button>
                                </div>
                            </div>
                            <textarea id="postResponseScript" class="hook-textarea" placeholder="// 在响应返回后执行，可处理响应数据
function postResponse(response) {
    const utils = response.utils;
    if (response.json) {
        const data = response.json;
        const fieldsToSave = ['id', 'token', 'x-uuid', 'x-name',];
        fieldsToSave.forEach(field => {
            if (data[field] !== undefined) {
                utils.setVariable('last_var_' + field, data[field]);
                utils.setGlobalHeader('last-header-' + field, data[field]);
            }
        });
        utils.success('已自动保存响应字段');
    }
    return response;
}"></textarea>
                        </div>

                        <div class="hook-console">
                            <div class="hook-console-header">
                                <span>控制台输出</span>
                                <button class="hook-console-clear" onclick="clearHookConsole()">清空</button>
                            </div>
                            <div id="hookConsoleOutput" class="hook-console-output"></div>
                        </div>
                    </div>

                    <div id="toolsTab" class="tab-content">
                        <div class="script-section">
                            <div class="script-section-header">
                                <span class="script-section-title">Curl 导入</span>
                                <button class="script-action-btn" onclick="importCurlFromTextarea()">导入</button>
                            </div>
                            <textarea id="curlImportArea" class="script-textarea"
                                placeholder="粘贴 curl 命令后点击导入按钮..."></textarea>
                        </div>
                        <div class="script-section">
                            <div class="script-section-header">
                                <span class="script-section-title">Curl 导出</span>
                                <button class="script-action-btn" onclick="exportCurlToTextarea()">生成</button>
                                <button class="script-action-btn" onclick="copyCurlExport()">复制</button>
                            </div>
                            <textarea id="curlExportArea" class="script-textarea" readonly
                                placeholder="点击生成按钮导出当前请求为 curl 命令..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="response-section">
                    <div class="response-info" id="responseInfo"></div>
                    <div class="response-tabs">
                        <div class="response-tab" onclick="switchResponseTab('headers')">响应头</div>
                        <div class="response-tab active" onclick="switchResponseTab('body')">响应体</div>
                    </div>
                    <div id="headersContent" class="response-tab-content">
                        <table class="headers-table" id="responseHeaders">
                            <thead>
                                <tr>
                                    <th>名称</th>
                                    <th>值</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="bodyContent" class="response-tab-content active">
                        <div class="response-actions">
                            <button onclick="copyResponse()">复制响应内容</button>
                            <button onclick="clearResponse()">清空响应内容</button>
                            <button id="formatJsonBtn" onclick="formatJsonResponse()"
                                class="container-hidden">格式化JSON</button>
                            <button id="copyFormattedBtn" onclick="copyFormattedJson()"
                                class="container-hidden">复制格式化JSON</button>
                        </div>
                        <div id="jsonFormattedContainer" class="container-hidden"></div>
                        <textarea id="responseBody" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="dialogOverlay"></div>
    <div class="settings-dialog" id="settingsDialog">
        <h3>请求配置</h3>
        <div class="settings-group">

            <label>缺省请求协议 (default_protocol)</label>
            <select id="settingDefaultProtocol">
                <option value="http">http</option>
                <option value="https">https</option>
                <option value="ws">ws</option>
                <option value="wss">wss</option>
            </select>

            <label>是否验证SSL (verify_ssl)</label>
            <select id="settingVerifySSL">
                <option value="Y">Y - 验证SSL</option>
                <option value="N">N - 不验证SSL</option>
            </select>

            <label>是否自动跟随重定向 (follow_redirect)</label>
            <select id="settingFollowRedirect">
                <option value="Y">Y - 自动跟随</option>
                <option value="N">N - 不跟随</option>
            </select>

            <label>请求超时时间 (秒, time_out)</label>
            <input type="number" id="settingTimeout" min="0" placeholder="0为不超时" class="setting-input">

            <label>请求重试次数 (retry_count)</label>
            <input type="number" id="settingRetryCount" min="0" placeholder="0为不重试" class="setting-input">

            <label>请求重试间隔 (秒, retry_delay)</label>
            <input type="number" id="settingRetryDelay" min="0" placeholder="0为无间隔" class="setting-input">

            <label>SSE事件类型列表 (逗号分隔)</label>
            <input type="text" id="settingSseEventTypes" placeholder="例如: update,info,warn" class="setting-input">

            <hr class="divider">

            <label>缓存策略 (cache)</label>
            <select id="settingCache">
                <option value="default">default - 默认，先在缓存里面寻找匹配的请求</option>
                <option value="no-store">no-store - 直接请求远程服务器，不更新缓存</option>
                <option value="reload">reload - 直接请求远程服务器，更新缓存</option>
                <option value="no-cache">no-cache - 将服务器资源跟本地缓存进行比较</option>
                <option value="force-cache">force-cache - 缓存优先</option>
                <option value="only-if-cached">only-if-cached - 只检查缓存</option>
            </select>

            <label>请求模式 (mode)</label>
            <select id="settingMode">
                <option value="cors">cors - 允许跨域请求</option>
                <option value="same-origin">same-origin - 只允许同源请求</option>
                <option value="no-cors">no-cors - 仅限简单请求方法和标头</option>
                <option value="navigate">navigate - navigate</option>
            </select>

            <label>发送凭证 (credentials)</label>
            <select id="settingCredentials">
                <option value="same-origin">same-origin - 同源发送Cookie</option>
                <option value="include">include - 同源和跨域都发送Cookie</option>
                <option value="omit">omit - 不发送Cookie</option>
            </select>

            <label>重定向处理 (redirect)</label>
            <select id="settingRedirect">
                <option value="follow">follow - 自动跟随跳转</option>
                <option value="error">error - 跳转时报错</option>
                <option value="manual">manual - 手动处理跳转</option>
            </select>

            <label>Referrer 策略 (referrerPolicy)</label>
            <select id="settingReferrerPolicy">
                <option value="no-referrer-when-downgrade">no-referrer-when-downgrade - 默认规则</option>
                <option value="no-referrer">no-referrer - 不发送Referrer</option>
                <option value="origin">origin - 只发送域名</option>
                <option value="origin-when-cross-origin">origin-when-cross-origin - 跨域时只发送域名</option>
                <option value="same-origin">same-origin - 仅同源发送</option>
                <option value="strict-origin">strict-origin - 安全降级时不发送</option>
                <option value="strict-origin-when-cross-origin">strict-origin-when-cross-origin - 安全跨域规则</option>
                <option value="unsafe-url">unsafe-url - 总是发送完整URL</option>
            </select>

            <label>Referrer</label>
            <select id="settingReferrer">
                <option value="about:client">about:client - 默认行为</option>
                <option value="">空 - 不发送referrer</option>
                <option value="custom">自定义</option>
            </select>
            <input type="text" id="settingReferrerCustom" placeholder="自定义referrer URL" class="setting-input-integrity">

            <label>完整性校验 (integrity)</label>
            <input type="text" id="settingIntegrity" placeholder="输入哈希值" class="setting-input">

            <label>保持连接 (keepalive)</label>
            <select id="settingKeepalive">
                <option value="false">false - 默认</option>
                <option value="true">true - 保持连接</option>
            </select>
        </div>
        <div class="dialog-buttons">
            <button onclick="closeSettings()">取消</button>
            <button onclick="saveSettings()" class="btn-primary">保存配置</button>
        </div>
    </div>

    <script>
        "use strict";
        /**
         * 全局变量：是否使用代理模式
         * @type {boolean}
         */
        let useProxy = false;

        /**
         * 函数别名称
         */
        const byId = id => document.getElementById(id);
        const docSelectAll = e => document.querySelectorAll(e);


        /**
         * 初始化代理模式状态
         * 页面加载时请求 /api/mode 接口获取当前运行模式
         * @returns {Promise<void>}
         */
        async function initUseProxy() {
            try {
                const modeResp = await fetch('/api/mode');
                if (modeResp.ok) {
                    const modeData = await modeResp.json();
                    if (modeData && modeData.mode === 'proxy') {
                        useProxy = true;
                    } else {
                        useProxy = false;
                    }
                } else {
                    useProxy = false;
                }
            } catch (e) {
                useProxy = false;
            }
        }

        /**
         * Hook脚本执行引擎
         * 负责管理和执行前置脚本（Pre-Request）和后置脚本（Post-Response）
         */
        const HookEngine = {
            /** @type {Array<{type: string, time: string, message: string}>} 控制台日志数组 */
            consoleLogs: [],

            /**
             * 记录日志到控制台
             * @param {string} type - 日志类型：info/success/error/warn
             * @param {...any} args - 日志内容
             */
            log(type, ...args) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');

                this.consoleLogs.push({ type, time: timeStr, message });
                this.renderConsole();
            },

            /**
             * 渲染控制台输出
             * 将日志数组转换为HTML并显示在控制台区域
             */
            renderConsole() {
                const output = byId('hookConsoleOutput');
                if (!output) return;

                output.innerHTML = this.consoleLogs.map(log => {
                    const typeClass = log.type || 'info';
                    return `<div class="hook-console-line ${typeClass}"><span class="hook-console-time">[${log.time}]</span>${this.escapeHtml(log.message)}</div>`;
                }).join('');

                output.scrollTop = output.scrollHeight;
            },

            /**
             * HTML转义，防止XSS攻击
             * @param {string} text - 需要转义的文本
             * @returns {string} 转义后的安全文本
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            /**
             * 清空控制台日志
             */
            clearConsole() {
                this.consoleLogs = [];
                this.renderConsole();
            },

            /**
             * 获取Hook脚本可用的工具函数集
             * @returns {Object} 工具函数对象
             */
            getUtils() {
                const self = this;
                return {
                    // 日志输出函数
                    log: (...args) => self.log('info', ...args),
                    info: (...args) => self.log('info', ...args),
                    success: (...args) => self.log('success', ...args),
                    warn: (...args) => self.log('warn', ...args),
                    error: (...args) => self.log('error', ...args),

                    /**
                     * 设置变量（保存到localStorage并刷新DOM）
                     * @param {string} name - 变量名
                     * @param {any} value - 变量值
                     */
                    setVariable: (name, value) => {
                        const envConf = StorageManager.get('env_conf', []);
                        const existingIndex = envConf.findIndex(v => v.env_name === name);
                        if (existingIndex >= 0) {
                            envConf[existingIndex].env_value = String(value);
                            envConf[existingIndex].enable = true;
                        } else {
                            envConf.push({ row_id: Date.now(), enable: true, env_name: name, env_value: String(value) });
                        }
                        StorageManager.set('env_conf', envConf);
                        // 刷新变量表格DOM
                        if (typeof loadVariables === 'function') {
                            loadVariables();
                        }
                        self.log('success', `变量已设置: ${name} = ${value}`);
                    },

                    /**
                     * 获取变量值（只获取启用的变量）
                     * @param {string} name - 变量名
                     * @returns {string|undefined} 变量值
                     */
                    getVariable: (name) => {
                        const envConf = StorageManager.get('env_conf', []);
                        const found = envConf.find(v => v.env_name === name && v.enable !== false);
                        return found ? found.env_value : undefined;
                    },

                    /**
                     * 获取所有启用的变量
                     * @returns {Object} 变量键值对对象
                     */
                    getAllVariables: () => {
                        const envConf = StorageManager.get('env_conf', []);
                        const result = {};
                        envConf.filter(v => v.enable !== false).forEach(v => { result[v.env_name] = v.env_value; });
                        return result;
                    },

                    /**
                     * 设置全局请求头（保存到localStorage并刷新DOM）
                     * @param {string} name - 请求头名称
                     * @param {string} value - 请求头值
                     */
                    setGlobalHeader: (name, value) => {
                        const headerConf = StorageManager.get('header_conf', []);
                        const existingIndex = headerConf.findIndex(h => h.header_name === name);
                        if (existingIndex >= 0) {
                            headerConf[existingIndex].header_value = String(value);
                            headerConf[existingIndex].enable = true;
                        } else {
                            headerConf.push({ row_id: Date.now(), enable: true, header_name: name, header_value: String(value) });
                        }
                        StorageManager.set('header_conf', headerConf);
                        // 刷新全局请求头表格DOM
                        if (typeof loadGlobalHeaders === 'function') {
                            loadGlobalHeaders();
                        }
                        self.log('success', `全局请求头已设置: ${name} = ${value}`);
                    },

                    /**
                     * 获取全局请求头值（只获取启用的请求头）
                     * @param {string} name - 请求头名称
                     * @returns {string|undefined} 请求头值
                     */
                    getGlobalHeader: (name) => {
                        const headerConf = StorageManager.get('header_conf', []);
                        const found = headerConf.find(h => h.header_name === name && h.enable !== false);
                        return found ? found.header_value : undefined;
                    },

                    /**
                     * 获取所有启用的全局请求头
                     * @returns {Object} 全局请求头键值对对象
                     */
                    getAllGlobalHeaders: () => {
                        const headerConf = StorageManager.get('header_conf', []);
                        const result = {};
                        headerConf.filter(h => h.enable !== false).forEach(h => { result[h.header_name] = h.header_value; });
                        return result;
                    },
                };
            },

            /**
             * 执行前置脚本（Pre-Request Hook）
             * 在请求发送前执行，可修改请求参数
             * @param {Object} request - 请求对象
             * @returns {Promise<Object>} 处理后的请求对象
             */
            async executePreRequest(request) {
                const scriptText = byId('preRequestScript')?.value || '';
                const enabled = byId('preRequestEnabled')?.checked !== false;

                // 如果未启用或脚本为空，直接返回原请求
                if (!enabled || !scriptText.trim()) {
                    return request;
                }

                this.log('info', '执行 Pre-Request Hook...');

                try {
                    const utils = this.getUtils();
                    // 构建传递给脚本的请求对象
                    const requestObj = {
                        url: request.url,
                        method: request.method,
                        headers: { ...request.headers },
                        body: request.body,
                        bodyType: request.bodyType,
                        settings: { ...request.settings },
                        variables: utils.getAllVariables(),
                        utils
                    };

                    // 包装脚本，使其能够被Function构造函数执行
                    const wrappedScript = `
                        ${scriptText}
                        return (typeof preRequest === 'function') ? preRequest(request) : request;
                    `;

                    // 执行脚本
                    const fn = new Function('request', wrappedScript);
                    const result = await fn(requestObj);

                    // 如果脚本返回了有效的对象，合并修改
                    if (result && typeof result === 'object') {
                        this.log('success', 'Pre-Request Hook 执行完成');
                        return {
                            ...request,
                            url: result.url || request.url,
                            method: result.method || request.method,
                            headers: result.headers || request.headers,
                            body: result.body !== undefined ? result.body : request.body,
                            settings: result.settings || request.settings
                        };
                    }

                    return request;
                } catch (error) {
                    this.log('error', `Pre-Request Hook 执行错误: ${error.message}`);
                    console.error('Pre-Request Hook Error:', error);
                    return request;
                }
            },

            /**
             * 执行后置脚本（Post-Response Hook）
             * 在响应返回后执行，可处理响应数据
             * @param {Object} response - 响应对象
             * @returns {Promise<Object>} 处理后的响应对象
             */
            async executePostResponse(response) {
                const scriptText = byId('postResponseScript')?.value || '';
                const enabled = byId('postResponseEnabled')?.checked !== false;

                // 如果未启用或脚本为空，直接返回原响应
                if (!enabled || !scriptText.trim()) {
                    return response;
                }

                this.log('info', '执行 Post-Response Hook...');

                try {
                    const utils = this.getUtils();
                    // 尝试解析JSON响应
                    let json = null;
                    try {
                        if (response.body && typeof response.body === 'string') {
                            json = JSON.parse(response.body);
                        }
                    } catch {
                        // 响应不是JSON格式
                    }

                    // 构建传递给脚本的响应对象
                    const responseObj = {
                        status: response.status,
                        statusText: response.statusText,
                        headers: { ...response.headers },
                        body: response.body,
                        duration: response.duration,
                        contentType: response.contentType,
                        json,
                        utils
                    };

                    // 包装脚本，使其能够被Function构造函数执行
                    const wrappedScript = `
                        ${scriptText}
                        return (typeof postResponse === 'function') ? postResponse(response) : response;
                    `;

                    // 执行脚本
                    const fn = new Function('response', wrappedScript);
                    const result = await fn(responseObj);

                    // 如果脚本返回了有效的对象，合并修改
                    if (result && typeof result === 'object') {
                        this.log('success', 'Post-Response Hook 执行完成');
                        return {
                            ...response,
                            body: result.body !== undefined ? result.body : response.body
                        };
                    }

                    return response;
                } catch (error) {
                    this.log('error', `Post-Response Hook 执行错误: ${error.message}`);
                    console.error('Post-Response Hook Error:', error);
                    return response;
                }
            },

            /**
             * 获取当前Hook脚本配置
             * @returns {Object} Hook脚本配置对象
             */
            getHookScripts() {
                return {
                    preRequest: {
                        enabled: byId('preRequestEnabled')?.checked !== false,
                        script: byId('preRequestScript')?.value || ''
                    },
                    postResponse: {
                        enabled: byId('postResponseEnabled')?.checked !== false,
                        script: byId('postResponseScript')?.value || ''
                    }
                };
            },

            /**
             * 设置Hook脚本配置
             * @param {Object} hooks - Hook脚本配置对象
             */
            setHookScripts(hooks) {
                if (hooks.preRequest) {
                    const preEnabled = byId('preRequestEnabled');
                    const preScript = byId('preRequestScript');
                    if (preEnabled) preEnabled.checked = hooks.preRequest.enabled !== false;
                    if (preScript) preScript.value = hooks.preRequest.script || '';
                }
                if (hooks.postResponse) {
                    const postEnabled = byId('postResponseEnabled');
                    const postScript = byId('postResponseScript');
                    if (postEnabled) postEnabled.checked = hooks.postResponse.enabled !== false;
                    if (postScript) postScript.value = hooks.postResponse.script || '';
                }
            }
        };

        /**
         * 清空Hook控制台日志
         */
        function clearHookConsole() {
            HookEngine.clearConsole();
        }

        /**
         * 清空Hook脚本内容
         * @param {string} type - 脚本类型：'preRequest' 或 'postResponse'
         */
        function clearHookScript(type) {
            if (type === 'preRequest') {
                byId('preRequestScript').value = '';
            } else if (type === 'postResponse') {
                byId('postResponseScript').value = '';
            }
        }

        /**
         * 切换Hook示例下拉菜单的显示状态
         * @param {string} type - 脚本类型：'preRequest' 或 'postResponse'
         */
        function toggleHookExampleMenu(type) {
            const menuId = type === 'preRequest' ? 'preRequestExampleMenu' : 'postResponseExampleMenu';
            const menu = byId(menuId);
            if (menu) {
                menu.classList.toggle('show');
            }
            // 点击其他区域时关闭菜单
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.hook-example-dropdown')) {
                    menu?.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        /**
         * Hook脚本示例集合
         * 包含前置脚本和后置脚本的常用示例
         */
        const HookExamples = {
            preRequest: {
                sign: `// 动态签名示例
function preRequest(request) {
    const timestamp = Date.now();
    const nonce = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
    const bodyStr = request.body || '';
    const secret = 'your_secret_key';
    
    // 简单签名示例（实际使用建议用更安全的算法）
    const signStr = bodyStr + timestamp + nonce + secret;
    
    // 设置签名相关请求头
    request.headers['X-Timestamp'] = timestamp;
    request.headers['X-Nonce'] = nonce;
    request.headers['X-Signature'] = signStr;
    
    request.utils.log('签名已生成');
    return request;
}`,
                timestamp: `// 添加时间戳示例
function preRequest(request) {
    console.log(request)
    const utils = request.utils;
    console.log(utils.getAllVariables());
    console.log(utils.getAllGlobalHeaders());
    const timestamp = Date.now();
    request.headers['X-Timestamp'] = String(timestamp);
    request.utils.log('已添加时间戳:', timestamp);
    return request;
}`,
                auth: `// 动态Token示例
function preRequest(request) {
    const token = request.utils.getVariable('auth_token');
    if (token) {
        request.headers['Authorization'] = 'Bearer ' + token;
        request.utils.log('已添加Token:', token.substring(0, 20) + '...');
    } else {
        request.utils.warn('未找到auth_token变量');
    }
    return request;
}`,
                env: `// 环境切换示例
function preRequest(request) {
    const env = request.utils.getVariable('current_env') || 'dev';
    
    const baseUrls = {
        dev: 'http://localhost:8080',
        test: 'http://test.example.com',
        prod: 'https://api.example.com'
    };
    
    const baseUrl = baseUrls[env] || baseUrls.dev;
    
    // 替换URL中的{{base_url}}
    request.url = request.url.replace('{{base_url}}', baseUrl);
    request.utils.log('当前环境:', env, 'BaseURL:', baseUrl);
    
    return request;
}`
            },
            postResponse: {
                extractToken: `// 提取Token示例
function postResponse(response) {
    const utils = response.utils;
    
    // 检查响应是否成功
    if (response.status === 200 && response.json) {
        // 尝试从不同位置提取token
        const token = response.json.token || 
                      response.json.data?.token ||
                      response.json.access_token;
        
        if (token) {
            utils.setVariable('auth_token', token);
            utils.success('Token已提取并保存:', token.substring(0, 20) + '...');
        }
    }
    
    // 检测token过期
    if (response.status === 401) {
        utils.warn('Token可能已过期');
    }
    
    return response;
}`,
                log: `// 日志记录示例
function postResponse(response) {
    const utils = response.utils;
    
    utils.info('=== 响应信息 ===');
    utils.info('状态码:', response.status);
    utils.info('耗时:', response.duration, 'ms');
    utils.info('Content-Type:', response.contentType);
    
    if (response.json) {
        utils.info('JSON数据:', JSON.stringify(response.json, null, 2));
    }
    
    return response;
}`,
                autoSave: `// 自动保存变量示例
function postResponse(response) {
    const utils = response.utils;
    console.log(response);
    if (response.json) {
        const data = response.json;
        const fieldsToSave = ['id', 'token', 'x-uuid', 'x-name',];
        fieldsToSave.forEach(field => {
            if (data[field] !== undefined) {
                utils.setVariable('last_var_' + field, data[field]);
                utils.setGlobalHeader('last-header-' + field, data[field]);
            }
        });
        utils.success('已自动保存响应字段');
    }
    return response;
}`
            }
        };

        /**
         * 加载Hook脚本示例
         * @param {string} type - 脚本类型：'preRequest' 或 'postResponse'
         * @param {string} exampleName - 示例名称
         */
        function loadHookExample(type, exampleName) {
            const examples = HookExamples[type];
            if (examples && examples[exampleName]) {
                const textareaId = type === 'preRequest' ? 'preRequestScript' : 'postResponseScript';
                byId(textareaId).value = examples[exampleName];
                HookEngine.log('info', `已加载示例: ${exampleName}`);
            }
            // 关闭菜单
            const menuId = type === 'preRequest' ? 'preRequestExampleMenu' : 'postResponseExampleMenu';
            byId(menuId)?.classList.remove('show');
        }

        /**
         * 切换请求标签页
         * @param {string} tabName - 标签页名称，可选值：'headers'、'body'、'script' 或 'tools'
         */
        function switchRequestTab(tabName) {
            docSelectAll('.request-tab').forEach(tab => tab.classList.remove('active'));
            docSelectAll('.tab-content').forEach(content => content.classList.remove('active'));

            let tabIndex = 1;
            if (tabName === 'body') tabIndex = 2;
            else if (tabName === 'script') tabIndex = 3;
            else if (tabName === 'tools') tabIndex = 4;

            const selectedTab = document.querySelector(`.request-tab:nth-child(${tabIndex})`);
            const selectedContent = byId(`${tabName}Tab`);

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
        }

        /**
         * 添加请求头行
         * 在请求头列表中添加一个新的请求头输入行
         */
        function addHeader() {
            const headerRow = document.createElement('div');
            headerRow.className = 'header-row';
            headerRow.innerHTML = `
                <input type="checkbox" checked>
                <input type="text" placeholder="Header名称"/>
                <input type="text" placeholder="Header值"/>
                <input type="text" placeholder="备注" class="header-remark input-remark"/>
                <button class="remove-btn" onclick="removeHeader(this)">删除</button>
            `;
            byId('headersList').appendChild(headerRow);
        }

        /**
         * 删除请求头行
         * @param {HTMLElement} button - 删除按钮元素
         */
        function removeHeader(button) {
            button.parentElement.remove();
        }

        /**
         * 更新请求体类型
         * 根据选择的请求体类型显示对应的容器，隐藏其他容器
         * @param {string} type - 请求体类型，可选值：'none', 'json', 'text', 'binary', 'form', 'formdata', 'websocket'
         */
        function updateBodyType(type) {
            const jsonBodyContainer = byId('jsonBodyContainer');
            const textBodyContainer = byId('textBodyContainer');
            const binaryBodyContainer = byId('binaryBodyContainer');
            const formDataContainer = byId('formDataContainer');
            const formContainer = byId('formContainer');
            const wsControls = byId('wsControls');
            const wsBodyContainer = byId('wsBodyContainer');

            // 隐藏所有容器
            jsonBodyContainer.style.display = 'none';
            textBodyContainer.style.display = 'none';
            binaryBodyContainer.style.display = 'none';
            formDataContainer.style.display = 'none';
            formContainer.style.display = 'none';
            wsControls.style.display = 'none';
            wsBodyContainer.style.display = 'none';

            switch (type) {
                case 'json':
                    jsonBodyContainer.style.display = 'block';
                    // 如果没有行，添加一个默认行
                    if (byId('jsonBodyRows').children.length === 0) {
                        addJsonBodyRow();
                    }
                    break;
                case 'text':
                    textBodyContainer.style.display = 'block';
                    // 如果没有行，添加一个默认行
                    if (byId('textBodyRows').children.length === 0) {
                        addTextBodyRow();
                    }
                    break;
                case 'binary':
                    binaryBodyContainer.style.display = 'block';
                    // 如果没有行，添加一个默认行
                    if (byId('binaryBodyRows').children.length === 0) {
                        addBinaryBodyRow();
                    }
                    break;
                case 'form':
                    formContainer.style.display = 'block';
                    break;
                case 'formdata':
                    formDataContainer.style.display = 'block';
                    break;
                case 'websocket':
                    wsBodyContainer.style.display = 'block';
                    if (byId('wsBodyRows').children.length === 0) {
                        addWsBodyRow();
                    }
                    break;
                case 'none':
                default:
                    // 无请求体，所有容器都隐藏
                    break;
            }
        }

        /**
         * 处理FormData文件输入变化
         * 为FormData文件输入框提供文件预览功能
         * @param {Event} e - 文件输入变化事件
         */
        function handleFormDataFileChange(e) {
            const filePreview = e.target.nextElementSibling;
            filePreview.innerHTML = '';
            for (let file of e.target.files) {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <span>${file.name}</span>
                    <small>(${(file.size / 1024).toFixed(2)} KB)</small>
                `;
                filePreview.appendChild(item);
            }
        }

        /**
         * 处理Binary请求体文件输入变化
         * 为Binary请求体文件输入框提供文件预览功能
         * @param {Event} e - 文件输入变化事件
         */
        function handleBinaryFileChange(e) {
            const file = e.target.files[0];
            const filePreview = e.target.nextElementSibling;
            if (file) {
                filePreview.innerHTML = `
                    <div class="file-preview-item">
                        <span>${file.name}</span>
                        <small>(${(file.size / 1024).toFixed(2)} KB)</small>
                    </div>
                `;
            } else {
                filePreview.innerHTML = '';
            }
        }

        /**
         * 创建JSON请求体行
         * 创建一个包含radio选择、textarea输入、备注和删除按钮的JSON请求体行
         * @returns {HTMLElement} 创建的JSON请求体行元素
         */
        function createJsonBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="jsonBodyRadio">
                <div class="body-content">
                    <textarea placeholder="{}" class="textarea-body json-body-textarea"></textarea>
                    <div class="json-body-formatted" style="display:none;"></div>
                </div>
                <textarea placeholder="备注" class="body-remark"></textarea>
                <div class="json-body-btn-group">
                    <button class="json-body-action-btn" onclick="formatJsonBodyRow(this)">格式化</button>
                    <button class="json-body-action-btn json-show-raw-btn" onclick="showRawJsonBodyRow(this)" style="display:none;">显示原始</button>
                    <button class="remove-btn" onclick="removeBodyRow(this, 'json')">删除</button>
                </div>
            `;
            return row;
        }

        /**
         * 格式化JSON请求体行
         * 将当前行的JSON文本解析并渲染为可折叠的高亮DOM结构
         * 隐藏原始textarea，显示格式化容器，切换按钮显示状态
         * @param {HTMLElement} btn - 触发格式化的按钮元素
         * @returns {void}
         */
        function formatJsonBodyRow(btn) {
            const btnGroup = btn.closest('.json-body-btn-group');
            const bodyRow = btn.closest('.body-row');
            const bodyContent = bodyRow.querySelector('.body-content');
            const textarea = bodyRow.querySelector('.json-body-textarea');
            const formattedContainer = bodyRow.querySelector('.json-body-formatted');
            const showRawBtn = btnGroup.querySelector('.json-show-raw-btn');

            try {
                const rawJson = textarea.value.trim();
                if (!rawJson) {
                    alert('没有JSON内容可格式化');
                    return;
                }

                const jsonObj = JSON.parse(rawJson);

                const textareaHeight = textarea.offsetHeight;
                bodyContent.style.height = textareaHeight + 'px';

                formattedContainer.innerHTML = '';
                const container = document.createElement('div');
                container.className = 'json-formatted';
                processValue(container, jsonObj);
                formattedContainer.appendChild(container);

                textarea.style.display = 'none';
                formattedContainer.style.display = 'block';
                btn.style.display = 'none';
                showRawBtn.style.display = 'inline-block';

            } catch (error) {
                alert('JSON格式错误: ' + (error.message || error));
            }
        }

        /**
         * 显示JSON请求体行的原始文本
         * 隐藏格式化容器，显示原始textarea，切换按钮显示状态
         * 与formatJsonBodyRow函数互斥，用于从格式化视图切换回原始编辑视图
         * @param {HTMLElement} btn - 触发显示原始文本的按钮元素
         * @returns {void}
         */
        function showRawJsonBodyRow(btn) {
            const btnGroup = btn.closest('.json-body-btn-group');
            const bodyRow = btn.closest('.body-row');
            const bodyContent = bodyRow.querySelector('.body-content');
            const textarea = bodyRow.querySelector('.json-body-textarea');
            const formattedContainer = bodyRow.querySelector('.json-body-formatted');
            const formatBtn = btnGroup.querySelector('.json-body-action-btn:not(.json-show-raw-btn)');

            bodyContent.style.height = '';
            textarea.style.display = 'block';
            formattedContainer.style.display = 'none';
            btn.style.display = 'none';
            formatBtn.style.display = 'inline-block';
        }

        /**
         * 创建Text请求体行
         * 创建一个包含radio选择、textarea输入、备注和删除按钮的Text请求体行
         * @returns {HTMLElement} 创建的Text请求体行元素
         */
        function createTextBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="textBodyRadio">
                <div class="body-content">
                    <textarea placeholder="text" class="textarea-body"></textarea>
                </div>
                <textarea placeholder="备注" class="body-remark"></textarea>
                <button class="remove-btn" onclick="removeBodyRow(this, 'text')">删除</button>
            `;
            return row;
        }

        /**
         * 创建Binary请求体行
         * 创建一个包含radio选择、文件输入、备注和删除按钮的Binary请求体行
         * @returns {HTMLElement} 创建的Binary请求体行元素
         */
        function createBinaryBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="binaryBodyRadio">
                <div class="body-content">
                    <input type="file" class="file-input-binary" onchange="handleBinaryFileChange(event)">
                    <div class="file-preview"></div>
                </div>
                <textarea placeholder="备注" class="body-remark"></textarea>
                <button class="remove-btn" onclick="removeBodyRow(this, 'binary')">删除</button>
            `;
            return row;
        }

        /**
         * 添加JSON请求体行
         * 在JSON请求体容器中添加一个新的JSON请求体行，如果是第一行则自动选中
         */
        function addJsonBodyRow() {
            const container = byId('jsonBodyRows');
            const row = createJsonBodyRow();
            container.appendChild(row);
            // 如果是第一行，自动选中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 添加Text请求体行
         * 在Text请求体容器中添加一个新的Text请求体行，如果是第一行则自动选中
         */
        function addTextBodyRow() {
            const container = byId('textBodyRows');
            const row = createTextBodyRow();
            container.appendChild(row);
            // 如果是第一行，自动选中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 添加Binary请求体行
         * 在Binary请求体容器中添加一个新的Binary请求体行，如果是第一行则自动选中
         */
        function addBinaryBodyRow() {
            const container = byId('binaryBodyRows');
            const row = createBinaryBodyRow();
            container.appendChild(row);
            // 如果是第一行，自动选中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 删除请求体行
         * 删除指定的请求体行，如果删除的是选中的行且还有其他行，则选中第一行
         * 如果没有行了，则添加一个默认行
         * @param {HTMLElement} button - 删除按钮元素
         * @param {string} type - 请求体类型，用于确定添加哪种类型的默认行
         */
        function removeBodyRow(button, type) {
            const row = button.closest('.body-row');
            const container = row.parentElement;
            const wasSelected = row.querySelector('input[type="radio"]').checked;

            row.remove();

            // 如果删除的是选中的行，且还有其他行，则选中第一行
            if (wasSelected && container.children.length > 0) {
                container.children[0].querySelector('input[type="radio"]').checked = true;
            }

            // 如果没有行了，添加一个默认行
            if (container.children.length === 0) {
                switch (type) {
                    case 'json':
                        addJsonBodyRow();
                        break;
                    case 'text':
                        addTextBodyRow();
                        break;
                    case 'binary':
                        addBinaryBodyRow();
                        break;
                }
            }
        }

        /**
         * 创建FormData行
         * 创建一个包含复选框、参数名、类型选择、值输入、备注和删除按钮的FormData行
         * @returns {HTMLElement} 创建的FormData行元素
         */
        function createFormDataRow() {
            const row = document.createElement('div');
            row.className = 'formdata-row';
            row.innerHTML = `
                <input type="checkbox" checked>
                <input type="text" class="formdata-key" placeholder="参数名称">
                <select class="formdata-type select-formdata-type" onchange="handleTypeChange(this)">
                    <option value="text">文本</option>
                    <option value="file">文件</option>
                </select>
                <div class="formdata-value">
                    <input type="text" class="text-input" placeholder="文本值">
                    <input type="file" class="file-input" multiple onchange="handleFormDataFileChange(event)">
                    <div class="file-preview"></div>
                </div>
                <input type="text" placeholder="备注" class="formdata-remark"/>
                <button class="remove-btn" onclick="removeFormDataRow(this)">删除</button>
            `;
            return row;
        }

        /**
         * 添加FormData行
         * 在FormData容器中添加一个新的FormData行
         */
        function addFormDataRow() {
            const container = byId('formDataRows');
            const row = createFormDataRow();
            container.appendChild(row);
        }

        /**
         * 删除FormData行
         * @param {HTMLElement} button - 删除按钮元素
         */
        function removeFormDataRow(button) {
            button.closest('.formdata-row').remove();
        }

        /**
         * 处理FormData类型变化
         * 根据选择的类型（文本/文件）显示对应的输入控件
         * @param {HTMLSelectElement} select - 类型选择下拉框元素
         */
        function handleTypeChange(select) {
            const row = select.closest('.formdata-row');
            const textInput = row.querySelector('.text-input');
            const fileInput = row.querySelector('.file-input');
            const filePreview = row.querySelector('.file-preview');

            if (select.value === 'text') {
                textInput.style.display = 'block';
                fileInput.style.display = 'none';
                filePreview.style.display = 'none';
                fileInput.value = ''; // 清除已选文件
            } else {
                textInput.style.display = 'none';
                fileInput.style.display = 'block';
                filePreview.style.display = 'block';
            }
        }

        /**
         * 添加表单行
         * 在表单容器中添加一个新的表单参数行
         */
        function addFormRow() {
            const formRow = document.createElement('div');
            formRow.className = 'header-row';
            formRow.innerHTML = `
                <input type="checkbox" checked>
                <input type="text" placeholder="参数名称"/>
                <input type="text" placeholder="参数值"/>
                <input type="text" placeholder="备注" class="form-remark input-remark"/>
                <button class="remove-btn" onclick="removeFormRow(this)">删除</button>
            `;
            byId('formRows').appendChild(formRow);
        }

        /**
         * 删除表单行
         * @param {HTMLElement} button - 删除按钮元素
         */
        function removeFormRow(button) {
            button.closest('.header-row').remove();
        }

        /**
         * 获取当前选择的请求体类型
         * @returns {string} 请求体类型，如果没有选择则返回 'none'
         */
        function getBodyType() {
            const checkedRadio = document.querySelector('input[name="bodyType"]:checked');
            return checkedRadio ? checkedRadio.value : 'none';
        }

        /**
         * 构建请求头
         * 获取并处理用户自定义请求头和全局请求头
         * @returns {Promise<Object>} 处理后的请求头对象
         */
        async function buildRequestHeaders() {
            // 获取用户自定义请求头
            const customHeaders = {};
            docSelectAll('#headersList .header-row').forEach(row => {
                const inputs = row.getElementsByTagName('input');
                const isEnabled = inputs[0]?.checked;
                const key = inputs[1]?.value;
                const value = inputs[2]?.value;

                if (isEnabled && key) {
                    // 替换header的key和value中的变量
                    const normalizedKey = replaceVariables(key)?.trim();
                    const normalizedValue = replaceVariables(value || '')?.trim();

                    // 验证header名称
                    if (normalizedKey) {
                        if (!/^[a-zA-Z0-9\-]+$/.test(normalizedKey)) {
                            throw new Error(`无效的请求头名称: ${normalizedKey}`);
                        }

                        // 规范化header名称（首字母大写，其余小写）
                        const finalKey = normalizedKey.split('-').map(part =>
                            part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                        ).join('-');
                        customHeaders[finalKey] = normalizedValue;
                    }
                }
            });

            // 获取全局请求头并规范化
            const globalHeaders = {};
            const rawGlobalHeaders = getGlobalHeaders();
            for (const [key, value] of Object.entries(rawGlobalHeaders)) {
                if (key) {
                    const normalizedKey = key.split('-').map(part =>
                        part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                    ).join('-');
                    globalHeaders[normalizedKey] = value;
                }
            }

            // 合并请求头，用户自定义的优先级更高
            const headers = { ...globalHeaders, ...customHeaders };

            // 验证所有请求头名称
            for (const key of Object.keys(headers)) {
                if (key && !/^[a-zA-Z0-9\-]+$/.test(key)) {
                    throw new Error(`无效的请求头名称: ${key}`);
                }
            }

            return headers;
        }

        /**
         * 规范化URL协议
         * 为URL添加默认协议前缀，支持http/https/ws/wss协议
         * @param {string} url - 原始URL
         * @param {string} protocol - 默认协议（http或https）
         * @returns {string} 规范化后的URL
         */
        function normalizeUrlWithProtocol(url, protocol) {
            if (!url) return url;
            // 只判断常用的四种协议
            if (/^(https?|wss?):\/\//i.test(url)) return url;
            if (url.startsWith('//')) return protocol + ':' + url;
            return protocol + '://' + url;
        }

        /**
         * 处理代理请求
         * 构建FormData并发送到代理服务器
         * @param {string} url - 目标URL
         * @param {string} method - 请求方法
         * @param {string} bodyType - 请求体类型
         * @param {Object} headers - 请求头
         * @param {Object} settings - 请求设置
         * @param {boolean} download - 是否为下载请求
         * @returns {Promise<void>}
         */
        async function handleProxyRequest(url, method, bodyType, headers, settings, download, signal, requestBody) {
            const formData = new FormData();
            formData.append('url', url);
            formData.append('method', method);
            formData.append('body_type', bodyType === 'formdata' ? 'form-data' : (bodyType === 'form' ? 'x-www-form-urlencoded' : bodyType));

            const headersArr = Object.entries(headers).map(([name, value]) => ({ name, value }));
            formData.append('headers', JSON.stringify(headersArr));
            formData.append('time_out', settings.timeout || '0');
            formData.append('verify_ssl', settings.verify_ssl || 'N');
            formData.append('follow_redirect', settings.follow_redirect || 'N');
            formData.append('retry_count', settings.retry_count || '0');
            formData.append('retry_delay', settings.retry_delay || '0');

            const filesInfo = [];
            await processRequestBodyWithBody(formData, bodyType, filesInfo, requestBody);

            if (filesInfo.length > 0) {
                formData.append('file_info', JSON.stringify(filesInfo));
            }

            try {
                const startTime = Date.now();
                const response = await fetch('/api/forward', {
                    method: 'POST',
                    body: formData,
                    signal: signal
                });
                const duration = Date.now() - startTime;
                const contentType = response.headers.get('content-type');

                if (contentType?.includes('text/event-stream')) {
                    await handleSSEFetchResponse(response);
                    saveRequestToHistory();
                    return;
                }

                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });

                let responseText = '';
                const binaryTypes = [
                    'application/octet-stream',
                    'application/pdf',
                    'image/',
                    'audio/',
                    'video/',
                    'application/zip',
                    'application/x-rar'
                ];
                const isBinaryContent = contentType && binaryTypes.some(type => contentType.includes(type));

                if (!isBinaryContent) {
                    responseText = await response.text();
                }

                const hookResponse = await HookEngine.executePostResponse({
                    status: response.status,
                    statusText: response.statusText,
                    headers: responseHeaders,
                    body: responseText,
                    duration,
                    contentType
                });

                if (hookResponse.body !== undefined && hookResponse.body !== responseText) {
                    responseText = hookResponse.body;
                }

                if (download) {
                    await handleDownloadResponse(response, contentType);
                } else {
                    await handleNormalResponseWithBody(response, duration, contentType, responseText, isBinaryContent);
                }

                await updateResponseHeaders(response);
                saveRequestToHistory();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    await handleRequestError(error);
                }
            } finally {
                currentAbortController = null;
            }
        }

        /**
         * 处理请求体（支持Hook修改后的请求体）
         * 如果Hook修改了请求体，则使用修改后的值；否则使用原始处理逻辑
         * @param {FormData} formData - FormData对象
         * @param {string} bodyType - 请求体类型
         * @param {Array} filesInfo - 文件信息数组
         * @param {string} requestBody - Hook修改后的请求体
         * @returns {Promise<void>}
         */
        async function processRequestBodyWithBody(formData, bodyType, filesInfo, requestBody) {
            if (requestBody) {
                if (bodyType === 'json' || bodyType === 'text' || bodyType === 'xml') {
                    formData.append('body', requestBody);
                }
                return;
            }
            await processRequestBody(formData, bodyType, filesInfo);
        }

        /**
         * 处理请求体
         * 根据请求体类型处理不同的数据
         * @param {FormData} formData - FormData对象
         * @param {string} bodyType - 请求体类型
         * @param {Array} filesInfo - 文件信息数组
         * @returns {Promise<void>}
         */
        async function processRequestBody(formData, bodyType, filesInfo) {
            switch (bodyType) {
                case 'formdata': {
                    const formDataRows = docSelectAll('.formdata-row');
                    for (const row of formDataRows) {
                        const isEnabled = row.querySelector('input[type="checkbox"]')?.checked;
                        if (!isEnabled) continue;

                        const key = row.querySelector('.formdata-key')?.value;
                        const type = row.querySelector('.formdata-type')?.value;
                        if (!key) continue;

                        if (type === 'text') {
                            const value = row.querySelector('.text-input')?.value || '';
                            formData.append(key, value);
                        } else if (type === 'file') {
                            const fileInput = row.querySelector('.file-input');
                            if (fileInput?.files.length > 0) {
                                for (const file of fileInput.files) {
                                    formData.append('files', file);
                                    filesInfo.push({ field_name: key, file_name: file.name });
                                }
                            } else {
                                formData.append(key, '');
                            }
                        }
                    }
                    break;
                }
                case 'form': {
                    const formRows = docSelectAll('#formRows .header-row');
                    for (const row of formRows) {
                        const inputs = row.getElementsByTagName('input');
                        const isEnabled = inputs[0]?.checked;
                        const key = inputs[1]?.value;
                        if (isEnabled && key) {
                            formData.append(key, inputs[2]?.value || '');
                        }
                    }
                    break;
                }
                case 'json':
                case 'text':
                case 'xml': {
                    const bodyContent = await getRequestBody(bodyType);
                    if (bodyContent) {
                        formData.append('body', bodyContent);
                    }
                    break;
                }
                case 'binary': {
                    const selectedRow = document.querySelector('#binaryBodyRows input[type="radio"]:checked');
                    if (selectedRow) {
                        const fileInput = selectedRow.closest('.body-row').querySelector('input[type="file"]');
                        if (fileInput?.files.length > 0) {
                            const file = fileInput.files[0];
                            formData.append('files', file);
                            filesInfo.push({ field_name: 'files', file_name: file.name });
                        }
                    }
                    break;
                }
            }
        }

        /**
         * 更新响应头显示
         * @param {Response} response - fetch响应对象
         * @returns {Promise<void>}
         */
        async function updateResponseHeaders(response) {
            const responseHeadersTable = byId('responseHeaders')?.getElementsByTagName('tbody')[0];
            if (!responseHeadersTable) return;

            responseHeadersTable.innerHTML = '';

            const allHeaders = response.headers.get('X-Response-Headers');
            if (allHeaders) {
                try {
                    const headers = JSON.parse(allHeaders);
                    for (const [key, values] of Object.entries(headers)) {
                        const row = responseHeadersTable.insertRow();
                        row.insertCell(0).textContent = key;
                        row.insertCell(1).textContent = Array.isArray(values) ? values.join(', ') : values;
                    }
                } catch (e) {
                    console.error('解析响应头失败:', e);
                }
            } else {
                // 回退到原始方式
                response.headers.forEach((value, key) => {
                    const row = responseHeadersTable.insertRow();
                    row.insertCell(0).textContent = key;
                    row.insertCell(1).textContent = value;
                });
            }
        }

        /**
         * 处理请求错误
         * @param {Error} error - 错误对象
         * @returns {Promise<void>}
         */
        async function handleRequestError(error) {
            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');
            const responseHeaders = byId('responseHeaders');

            if (responseInfo) {
                if (error.name === 'AbortError') {
                    responseInfo.innerHTML = '请求已取消';
                    responseInfo.className = 'response-info httpStatus4';
                } else {
                    responseInfo.innerHTML = `请求错误: ${error.message}`;
                }
            }
            if (responseBody) {
                responseBody.value = '';
            }
            if (responseHeaders) {
                const tbody = responseHeaders.getElementsByTagName('tbody')[0];
                if (tbody) {
                    tbody.innerHTML = '';
                }
            }
        }

        /**
         * 处理WebSocket/SSE请求
         * @param {string} url - 目标URL
         * @param {string} method - 请求方法 (WS/SSE)
         * @param {Object} headers - 请求头
         * @param {Object} settings - 请求设置
         * @param {AbortSignal} signal - AbortController 的信号
         * @returns {Promise<void>}
         */
        async function handleWSRequest(url, method, headers, settings, signal) {
            // 断开已有连接
            if (currentWS) {
                try { currentWS.close(); } catch (e) { }
                currentWS = null;
            }
            if (currentSSE) {
                try { currentSSE.close(); } catch (e) { }
                currentSSE = null;
            }

            // 清空响应区域
            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');
            const responseHeaders = byId('responseHeaders');

            if (responseInfo) responseInfo.innerHTML = '';
            if (responseBody) responseBody.value = '';
            if (responseHeaders) {
                const tbody = responseHeaders.getElementsByTagName('tbody')[0];
                if (tbody) tbody.innerHTML = '';
            }

            // 构造 formData
            const formData = new FormData();
            formData.append('url', url);
            formData.append('method', method);
            formData.append('body_type', 'none');
            const headersArr = Object.entries(headers).map(([name, value]) => ({ name, value }));
            formData.append('headers', JSON.stringify(headersArr));
            formData.append('time_out', settings.timeout || '0');
            formData.append('verify_ssl', settings.verify_ssl || 'N');
            formData.append('follow_redirect', settings.follow_redirect || 'N');
            formData.append('retry_count', settings.retry_count || '0');
            formData.append('retry_delay', settings.retry_delay || '0');

            try {
                const resp = await fetch('/api/forward', { method: 'POST', body: formData, signal: signal });
                const data = await resp.json();
                if (data.code !== 0) {
                    if (responseInfo) {
                        responseInfo.innerHTML = '连接失败: ' + (data.msg || '未知错误');
                    }
                    return;
                }

                const connect_id = data.connect_id;
                if (method === 'WS') {
                    await establishWSConnection(connect_id);
                } else if (method === 'SSE') {
                    await establishSSEConnection(connect_id);
                }
            } catch (err) {
                if (responseInfo) {
                    if (err.name === 'AbortError') {
                        responseInfo.innerHTML = '请求已取消';
                        responseInfo.className = 'response-info httpStatus4';
                    } else {
                        responseInfo.innerHTML = '请求错误: ' + (err.message || err);
                    }
                }
                console.error('WS/SSE请求错误:', err);
            }
        }

        /**
         * 建立WebSocket连接
         * @param {string} connect_id - 连接ID
         * @returns {Promise<void>}
         */
        async function establishWSConnection(connect_id) {
            const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${wsProto}://${location.host}/api/forward-ws?connect_id=${connect_id}`;
            const ws = new WebSocket(wsUrl);
            currentWS = ws;

            const responseBody = byId('responseBody');
            if (responseBody) responseBody.value = '';

            ws.onopen = function () {
                const responseInfo = byId('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'WebSocket 连接已建立';
                }
                saveRequestToHistory();
            };

            ws.onmessage = function (e) {
                // 处理WS响应头
                try {
                    if (typeof e.data === 'string') {
                        const obj = JSON.parse(e.data);
                        if (obj.type === 'headers' && obj.headers) {
                            updateWSResponseHeaders(obj.headers);
                            return;
                        }
                    }

                } catch (err) {
                    console.warn('解析WS响应头失败:', err);
                }

                // 处理普通消息
                const responseBody = byId('responseBody');
                if (!responseBody) return;

                if (typeof e.data === 'string') {
                    // 文本消息
                    responseBody.value += e.data + '\n';
                } else if (e.data instanceof Blob) {
                    // Blob 类型，转为 base64 或 hex 或 utf-8 字符串
                    const reader = new FileReader();
                    reader.onload = function () {
                        // 你可以选择显示为 base64、hex 或 utf-8
                        // 这里是 base64
                        /*
                        const base64 = btoa(
                            new Uint8Array(reader.result)
                                .reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                        responseBody.value += '[Blob] base64: ' + base64 + '\n';
                        */
                        responseBody.value += '[Blob] data\n';

                    };
                    reader.readAsArrayBuffer(e.data);
                } else if (e.data instanceof ArrayBuffer) {
                    // ArrayBuffer 类型，转为 hex 或 base64
                    /*
                    const arr = new Uint8Array(e.data);
                    const hex = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join(' ');
                    responseBody.value += '[ArrayBuffer] hex: ' + hex + '\n';
                    */
                    responseBody.value += '[ArrayBuffer] data\n';
                } else {
                    responseBody.value += '[Unknown WS message type]\n';
                }
            };

            ws.onerror = function (e) {
                const responseInfo = byId('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'WebSocket 错误';
                }
            };

            ws.onclose = function () {
                const responseInfo = byId('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'WebSocket 连接已关闭';
                }
                currentWS = null;
            };

            // 绑定发送/关闭按钮
            bindWSButtons(ws);
        }

        /**
         * 建立SSE连接
         * @param {string} connect_id - 连接ID
         * @returns {Promise<void>}
         */
        async function establishSSEConnection(connect_id) {
            const sseUrl = `/api/forward-sse?connect_id=${connect_id}`;
            const es = new EventSource(sseUrl);
            currentSSE = es;

            const responseBody = byId('responseBody');
            if (responseBody) responseBody.value = '';

            const responseInfo = byId('responseInfo');
            if (responseInfo) {
                responseInfo.innerHTML = 'SSE 连接已建立';
            }
            saveRequestToHistory();

            // 监听x-web-curl-headers事件，专门处理响应头
            es.addEventListener('x-web-curl-headers', function (e) {
                try {
                    const obj = JSON.parse(e.data);
                    updateWSResponseHeaders(obj);
                } catch (err) {
                    console.warn('解析SSE响应头失败:', err);
                }
            });

            es.onmessage = function (e) {
                const responseBody = byId('responseBody');
                if (responseBody) {
                    responseBody.value += `[message] ${e.data || ''}\n`;
                }
            };

            // 注册用户配置的SSE事件类型监听器
            const settings = getRequestSettings();
            if (settings.sse_event_types) {
                const sseEventTypeList = settings.sse_event_types.split(',').map(type => type.trim()).filter(type => type);
                sseEventTypeList.forEach(type => {
                    if (type && type !== 'message' && type !== 'x-web-curl-headers') {
                        es.addEventListener(type, function (e) {
                            const responseBody = byId('responseBody');
                            if (responseBody) {
                                responseBody.value += `[${type}] ${e.data || ''}\n`;
                            }
                        });
                    }
                });
            }

            es.onerror = function (e) {
                const responseInfo = byId('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'SSE 连接已关闭';
                }
                es.close();
                currentSSE = null;
            };
        }

        /**
         * 更新WebSocket/SSE响应头
         * @param {Object} headers - 响应头对象
         */
        function updateWSResponseHeaders(headers) {
            const responseHeadersTable = byId('responseHeaders')?.getElementsByTagName('tbody')[0];
            if (!responseHeadersTable) return;

            responseHeadersTable.innerHTML = '';
            for (const [key, values] of Object.entries(headers)) {
                const row = responseHeadersTable.insertRow();
                row.insertCell(0).textContent = key;
                row.insertCell(1).textContent = Array.isArray(values) ? values.join(', ') : values;
            }
        }

        /**
         * 设置Content-Type并获取请求体
         * @param {Object} headers - 请求头对象
         * @param {string} bodyType - 请求体类型
         * @param {Object} requestOptions - 请求选项
         * @returns {Promise<void>}
         */
        async function setContentTypeAndBody(headers, bodyType, requestOptions, requestBody) {
            switch (bodyType) {
                case 'form':
                    headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    break;
                case 'json':
                    headers['Content-Type'] = 'application/json';
                    break;
                case 'text':
                    const customContentType = headers['Content-Type'];
                    if (customContentType && customContentType.startsWith('text/')) {
                        headers['Content-Type'] = customContentType;
                    } else {
                        headers['Content-Type'] = 'text/plain';
                    }
                    break;
                case 'binary':
                    headers['Content-Type'] = 'application/octet-stream';
                    break;
            }

            if (requestBody !== undefined && requestBody !== null) {
                requestOptions.body = requestBody;
            } else {
                requestOptions.body = await getRequestBody(bodyType);
            }
        }

        /**
         * 绑定WebSocket按钮事件
         * @param {WebSocket} ws - WebSocket实例
         */
        function bindWSButtons(ws) {
            const wsSendBtn = byId('wsSendBtn');
            const wsCloseBtn = byId('wsCloseBtn');
            const wsSendInput = byId('wsSendInput');

            if (wsSendBtn) {
                wsSendBtn.onclick = function () {
                    const msg = wsSendInput?.value || '';
                    if (ws && ws.readyState === 1) {
                        try {
                            ws.send(msg);
                        } catch (err) {
                            console.error('发送WS消息失败:', err);
                        }
                    }
                };
            }

            if (wsCloseBtn) {
                wsCloseBtn.onclick = function () {
                    if (ws && ws.readyState === 1) {
                        try {
                            ws.close();
                        } catch (err) {
                            console.error('关闭WS连接失败:', err);
                        }
                    }
                };
            }
        }

        /**
         * 获取请求体内容
         * 根据请求体类型获取对应的请求体数据
         * @param {string} bodyType - 请求体类型
         * @returns {Promise<string|FormData|ArrayBuffer|null>} 请求体数据，根据类型返回不同格式
         * @throws {Error} 当JSON格式不正确或未选择文件时抛出错误
         */
        async function getRequestBody(bodyType) {
            const getSelectedRow = (selector) => {
                const row = document.querySelector(selector);
                if (!row) {
                    throw new Error(`请选择一个${bodyType}请求体`);
                }
                return row;
            };

            switch (bodyType) {
                case 'json': {
                    try {
                        const selectedRow = getSelectedRow('#jsonBodyRows input[type="radio"]:checked');
                        const jsonText = selectedRow.closest('.body-row').querySelector('textarea')?.value || '';
                        // 验证JSON格式的合法性
                        JSON.parse(jsonText);
                        return jsonText;
                    } catch (e) {
                        throw new Error(`JSON格式不正确: ${e.message}`);
                    }
                }
                case 'text': {
                    const selectedTextRow = getSelectedRow('#textBodyRows input[type="radio"]:checked');
                    return selectedTextRow.closest('.body-row').querySelector('textarea')?.value || '';
                }
                case 'binary': {
                    const selectedBinaryRow = getSelectedRow('#binaryBodyRows input[type="radio"]:checked');
                    const fileInput = selectedBinaryRow.closest('.body-row').querySelector('input[type="file"]');
                    if (!fileInput?.files.length) {
                        throw new Error('请选择要上传的文件');
                    }
                    return await fileInput.files[0].arrayBuffer();
                }
                case 'form': {
                    const formData = new URLSearchParams();
                    docSelectAll('#formRows .header-row').forEach((row) => {
                        const inputs = row.getElementsByTagName('input');
                        const isEnabled = inputs[0]?.checked;
                        const key = inputs[1]?.value;
                        if (isEnabled && key) {
                            formData.append(key, inputs[2]?.value || '');
                        }
                    });
                    return formData.toString();
                }
                case 'formdata': {
                    const multipartFormData = new FormData();
                    const formDataRows = docSelectAll('.formdata-row');
                    for (const row of formDataRows) {
                        const isEnabled = row.querySelector('input[type="checkbox"]')?.checked;
                        if (!isEnabled) continue;

                        const key = row.querySelector('.formdata-key')?.value;
                        const type = row.querySelector('.formdata-type')?.value;
                        if (!key) continue;

                        if (type === 'text') {
                            const value = row.querySelector('.text-input')?.value || '';
                            multipartFormData.append(key, value);
                        } else if (type === 'file') {
                            const fileInput = row.querySelector('.file-input');
                            if (fileInput?.files.length > 0) {
                                for (const file of fileInput.files) {
                                    multipartFormData.append(key, file);
                                }
                            } else {
                                multipartFormData.append(key, '');
                            }
                        }
                    }
                    return multipartFormData;
                }
                default:
                    return null;
            }
        }

        /**
         * 处理下载类型的HTTP响应
         * 将响应内容保存为文件并在页面上显示相关信息
         * @param {Response} response - fetch API 的响应对象
         * @param {string} contentType - 响应内容类型
         * @returns {Promise<void>}
         * @throws {Error} 当HTTP响应状态不是ok时抛出
         */
        async function handleDownloadResponse(response, contentType) {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 提取文件名
            let filename = '';
            const contentDisposition = response.headers.get('content-disposition');
            if (contentDisposition?.includes('filename=')) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch?.[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                    try {
                        filename = decodeURIComponent(filename);
                    } catch (e) {
                        console.warn('文件名解码失败:', e);
                    }
                }
            }

            if (!filename) {
                const extension = contentType?.split('/').pop()?.split(';')[0] || 'txt';
                filename = `downloaded_file.${extension}`;
            }

            const blob = await response.blob();
            const downloadUrl = URL.createObjectURL(blob);

            // 使用现代下载方式
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);

            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');

            if (responseInfo) {
                responseInfo.innerHTML = `
                    状态码: ${response.status} ${response.statusText}<br>
                    文件名: ${filename}<br>
                    文件大小: ${(blob.size / 1024).toFixed(2)} KB<br>
                    内容类型: ${contentType || '未指定'}<br>
                `;
                responseInfo.classList = 'response-info httpStatus' + (response.status + "").substr(0, 1);
            }

            if (responseBody) {
                responseBody.value = '[二进制文件内容已下载]';
            }
        }

        /**
         * 处理普通HTTP响应（非下载）
         * 在页面上显示响应信息、响应体和格式化按钮（如为JSON）
         * @param {Response} response - fetch API 的响应对象
         * @param {number} duration - 响应耗时，单位ms
         * @param {string} contentType - 响应内容类型
         * @returns {Promise<void>}
         */
        async function handleNormalResponse(response, duration, contentType) {
            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');

            if (responseInfo) {
                responseInfo.innerHTML = `
                    状态码: ${response.status} ${response.statusText}<br>
                    响应时间: ${duration}ms<br>
                    内容类型: ${contentType || '未指定'}<br>
                `;
                responseInfo.classList = 'response-info httpStatus' + (response.status + "").substr(0, 1);
            }

            // 重置JSON格式化状态
            resetJsonFormatState();

            // 二进制内容类型检测
            const binaryTypes = [
                'application/octet-stream',
                'application/pdf',
                'image/',
                'audio/',
                'video/',
                'application/zip',
                'application/x-rar'
            ];

            const isBinaryContent = contentType && binaryTypes.some(type => contentType.includes(type));

            if (isBinaryContent) {
                if (responseBody) {
                    responseBody.value = `[二进制内容] - ${contentType}\n建议使用"发送并下载"按钮下载此内容`;
                }
            } else {
                const responseText = await response.text();
                if (responseBody) {
                    responseBody.value = responseText;
                }

                // 检测是否为JSON响应
                const isJsonContentType = contentType?.includes('application/json');
                const isJsonFormat = responseText.trim() && (
                    responseText.trim().startsWith('{') ||
                    responseText.trim().startsWith('[')
                );

                if (isJsonContentType || (isJsonFormat && (() => {
                    try {
                        JSON.parse(responseText.trim());
                        return true;
                    } catch {
                        return false;
                    }
                })())) {
                    showJsonFormatButton();
                }
            }
        }

        /**
         * 重置JSON格式化状态
         * 隐藏格式化容器和按钮，显示原始响应内容
         */
        function resetJsonFormatState() {
            const elements = {
                container: byId('jsonFormattedContainer'),
                textarea: byId('responseBody'),
                formatBtn: byId('formatJsonBtn'),
                copyBtn: byId('copyFormattedBtn')
            };

            if (elements.container) elements.container.style.display = 'none';
            if (elements.textarea) elements.textarea.style.display = 'block';
            if (elements.formatBtn) elements.formatBtn.style.display = 'none';
            if (elements.copyBtn) elements.copyBtn.style.display = 'none';

            isJsonFormatted = false;
        }

        /**
         * 显示JSON格式化按钮
         * 当检测到响应为JSON格式时显示格式化按钮
         */
        function showJsonFormatButton() {
            const formatJsonBtn = byId('formatJsonBtn');
            if (formatJsonBtn) {
                formatJsonBtn.style.display = 'inline-block';
            }
        }

        // 全局变量，保存当前WS/SSE连接
        let currentWS = null;
        let currentSSE = null;
        let currentAbortController = null;

        // localStorage管理工具
        const StorageManager = {
            /**
             * 安全地从localStorage获取数据
             * @param {string} key - 存储键
             * @param {any} defaultValue - 默认值
             * @returns {any} 解析后的数据
             */
            get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error(`读取localStorage失败 [${key}]:`, error);
                    return defaultValue;
                }
            },

            /**
             * 安全地向localStorage存储数据
             * @param {string} key - 存储键
             * @param {any} value - 要存储的数据
             */
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error(`写入localStorage失败 [${key}]:`, error);
                }
            },

            /**
             * 从localStorage删除数据
             * @param {string} key - 存储键
             */
            remove(key) {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.error(`删除localStorage失败 [${key}]:`, error);
                }
            }
        };

        /**
         * 设置请求按钮状态
         * @param {boolean} loading - 是否处于加载状态
         */
        function setRequestButtonsState(loading) {
            const sendBtn = byId('sendBtn');
            const sendBtnGroup = byId('sendBtnGroup');

            if (sendBtn) {
                if (loading) {
                    sendBtn.disabled = false;
                    sendBtn.classList.add('loading');
                    sendBtn.textContent = '取消';
                } else {
                    sendBtn.disabled = false;
                    sendBtn.classList.remove('loading');
                    sendBtn.textContent = '发送';
                }
            }

            if (sendBtnGroup) {
                if (loading) {
                    sendBtnGroup.classList.add('loading-group');
                } else {
                    sendBtnGroup.classList.remove('loading-group');
                }
            }
        }

        /**
         * 切换发送按钮下拉菜单
         * @param {Event} event - 点击事件
         */
        function toggleSendDropdown(event) {
            event.stopPropagation();
            const menu = byId('sendDropdownMenu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        /**
         * 关闭发送按钮下拉菜单
         */
        function closeSendDropdown() {
            const menu = byId('sendDropdownMenu');
            if (menu) {
                menu.classList.remove('show');
            }
        }

        document.addEventListener('click', function (event) {
            const sendBtnGroup = byId('sendBtnGroup');
            if (sendBtnGroup && !sendBtnGroup.contains(event.target)) {
                closeSendDropdown();
            }
        });

        /**
         * 处理发送按钮点击事件
         * 根据按钮当前状态决定是发送请求还是取消请求
         */
        function handleSendButtonClick() {
            const sendBtn = byId('sendBtn');
            if (!sendBtn) return;

            if (sendBtn.classList.contains('loading')) {
                cancelRequest();
            } else {
                sendRequest();
            }
        }

        /**
         * 取消当前请求
         * 调用 AbortController 中断正在进行的请求
         */
        function cancelRequest() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }
            if (currentWS) {
                try {
                    currentWS.close();
                } catch (e) {
                    console.warn('关闭WS连接时出错:', e);
                }
                currentWS = null;
            }
            if (currentSSE) {
                try {
                    currentSSE.close();
                } catch (e) {
                    console.warn('关闭SSE连接时出错:', e);
                }
                currentSSE = null;
            }
            setRequestButtonsState(false);
        }

        /**
         * 发送HTTP请求或建立WS/SSE连接
         * 根据请求方法和代理模式选择不同的处理方式
         * @param {boolean} download - 是否为下载请求
         * @returns {Promise<void>}
         */
        async function sendRequest(download = false) {
            clearResponse();
            setRequestButtonsState(true);

            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;

            try {
                const methodElement = byId('httpMethod');
                const urlElement = byId('url');

                if (!methodElement || !urlElement) {
                    throw new Error('无法获取请求方法或URL');
                }

                let method = methodElement.value;
                let url = urlElement.value;
                const bodyType = getBodyType();

                url = replaceVariables(url)?.trim() || '';
                const settings = getRequestSettings();
                url = normalizeUrlWithProtocol(url, settings.default_protocol);
                if (!url) {
                    throw new Error('请输入有效的URL');
                }

                let headers = await buildRequestHeaders();

                let requestBody = null;
                if (bodyType !== 'none' && method !== 'GET') {
                    requestBody = await getRequestBody(bodyType);
                }

                const hookRequest = await HookEngine.executePreRequest({
                    url,
                    method,
                    headers,
                    body: requestBody,
                    bodyType,
                    settings
                });

                url = hookRequest.url;
                method = hookRequest.method;
                headers = hookRequest.headers;
                requestBody = hookRequest.body;

                const requestOptions = {
                    method,
                    headers,
                    cache: settings.cache,
                    mode: settings.mode,
                    credentials: settings.credentials,
                    redirect: settings.redirect,
                    referrer: settings.referrer,
                    referrerPolicy: settings.referrerPolicy,
                    integrity: settings.integrity || undefined,
                    keepalive: settings.keepalive,
                    signal: signal
                };

                if (useProxy && method !== 'WS' && method !== 'SSE') {
                    await handleProxyRequest(url, method, bodyType, headers, settings, download, signal, requestBody);
                    return;
                }

                if (useProxy && (method === 'WS' || method === 'SSE')) {
                    await handleWSRequest(url, method, headers, settings, signal);
                    return;
                }

                if (bodyType !== 'none' && method !== 'GET') {
                    await setContentTypeAndBody(headers, bodyType, requestOptions, requestBody);
                }

                const startTime = Date.now();
                const response = await fetch(url, requestOptions);
                const duration = Date.now() - startTime;
                const contentType = response.headers.get('content-type');

                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });

                let responseText = '';
                const binaryTypes = [
                    'application/octet-stream',
                    'application/pdf',
                    'image/',
                    'audio/',
                    'video/',
                    'application/zip',
                    'application/x-rar'
                ];
                const isBinaryContent = contentType && binaryTypes.some(type => contentType.includes(type));

                if (!isBinaryContent) {
                    responseText = await response.text();
                }

                const hookResponse = await HookEngine.executePostResponse({
                    status: response.status,
                    statusText: response.statusText,
                    headers: responseHeaders,
                    body: responseText,
                    duration,
                    contentType
                });

                if (hookResponse.body !== undefined && hookResponse.body !== responseText) {
                    responseText = hookResponse.body;
                }

                if (download) {
                    await handleDownloadResponse(response, contentType);
                } else {
                    await handleNormalResponseWithBody(response, duration, contentType, responseText, isBinaryContent);
                }

                await updateResponseHeaders(response);
                saveRequestToHistory();
            } catch (error) {
                await handleRequestError(error);
            } finally {
                currentAbortController = null;
                setRequestButtonsState(false);
            }
        }

        /**
         * 处理普通响应（带响应体）
         * 用于Hook执行后显示响应内容
         * @param {Response} response - fetch响应对象
         * @param {number} duration - 响应耗时（毫秒）
         * @param {string} contentType - 响应内容类型
         * @param {string} responseText - 响应体文本
         * @param {boolean} isBinaryContent - 是否为二进制内容
         * @returns {Promise<void>}
         */
        async function handleNormalResponseWithBody(response, duration, contentType, responseText, isBinaryContent) {
            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');

            if (responseInfo) {
                responseInfo.innerHTML = `
                    状态码: ${response.status} ${response.statusText}<br>
                    响应时间: ${duration}ms<br>
                    内容类型: ${contentType || '未指定'}<br>
                `;
                responseInfo.classList = 'response-info httpStatus' + (response.status + "").substr(0, 1);
            }

            resetJsonFormatState();

            if (isBinaryContent) {
                if (responseBody) {
                    responseBody.value = `[二进制内容] - ${contentType}\n建议使用"发送并下载"按钮下载此内容`;
                }
            } else {
                if (responseBody) {
                    responseBody.value = responseText;
                }

                const isJsonContentType = contentType?.includes('application/json');
                const isJsonFormat = responseText.trim() && (
                    responseText.trim().startsWith('{') ||
                    responseText.trim().startsWith('[')
                );

                if (isJsonContentType || (isJsonFormat && (() => {
                    try {
                        JSON.parse(responseText.trim());
                        return true;
                    } catch {
                        return false;
                    }
                })())) {
                    showJsonFormatButton();
                }
            }
        }

        /**
         * 发送请求并下载响应内容
         * @returns {Promise<void>}
         */
        async function sendRequestAndDownload() {
            closeSendDropdown();
            clearResponse();
            await sendRequest(true);
        }

        /**
         * 切换响应标签页
         * @param {string} tabName - 标签页名称，可选值：'headers' 或 'body'
         */
        function switchResponseTab(tabName) {
            docSelectAll('.response-tab').forEach(tab => tab.classList.remove('active'));
            docSelectAll('.response-tab-content').forEach(content => content.classList.remove('active'));

            const selectedTab = document.querySelector(`.response-tab:nth-child(${tabName === 'headers' ? '1' : '2'})`);
            const selectedContent = byId(`${tabName}Content`);

            selectedTab.classList.add('active');
            selectedContent.classList.add('active');
        }

        /**
         * 复制响应内容到剪贴板
         */
        async function copyResponse() {
            const responseBody = byId('responseBody');
            if (!responseBody?.value) return;

            try {
                if (typeof navigator !== 'undefined' && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    await navigator.clipboard.writeText(responseBody.value);
                    console.log('响应内容已复制到剪贴板');
                } else {
                    console.warn('剪贴板API不可用');
                }
            } catch (err) {
                console.error('复制响应内容失败:', err);
            }
        }

        /**
         * 清空响应内容
         * 清空响应信息、响应体、响应头，并断开WS/SSE连接
         */
        function clearResponse() {
            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');
            const responseHeaders = byId('responseHeaders');

            if (responseInfo) responseInfo.innerHTML = '';
            if (responseBody) responseBody.value = '';
            if (responseHeaders) {
                const tbody = responseHeaders.getElementsByTagName('tbody')[0];
                if (tbody) tbody.innerHTML = '';
            }

            // 重置JSON格式化状态
            resetJsonFormatState();

            // 安全关闭连接
            if (currentWS) {
                try {
                    currentWS.close();
                } catch (e) {
                    console.warn('关闭WS连接时出错:', e);
                }
                currentWS = null;
            }
            if (currentSSE) {
                try {
                    currentSSE.close();
                } catch (e) {
                    console.warn('关闭SSE连接时出错:', e);
                }
                currentSSE = null;
            }
        }

        // 历史记录相关函数
        const MAX_HISTORY_ITEMS = 50; // 最大历史记录数

        /**
         * 保存当前请求到历史记录
         * 将当前请求的所有信息（方法、URL、请求头、请求体）保存到localStorage
         */
        function saveRequestToHistory() {
            const method = byId('httpMethod').value;
            const url = byId('url').value;
            const bodyType = getBodyType();

            // 获取请求头
            const headers = {};
            docSelectAll('#headersList .header-row').forEach(row => {
                const inputs = row.getElementsByTagName('input');
                const isEnabled = inputs[0].checked;
                // 只要有key就保存
                if (inputs[1].value) {
                    headers[inputs[1].value] = {
                        // 如果value为空，使用空字符串
                        value: inputs[2].value || '',
                        // 保存复选框状态
                        enabled: isEnabled,
                        // 保存备注
                        remark: inputs[3].value || ''
                    };
                }
            });

            // 获取请求体
            let body = null;
            if (bodyType === 'form') {
                const formData = {};
                docSelectAll('#formRows .header-row').forEach((row) => {
                    const inputs = row.getElementsByTagName('input');
                    const isEnabled = inputs[0].checked;
                    // 只要有key就保存
                    if (inputs[1].value) {
                        formData[inputs[1].value] = {
                            // 如果value为空，使用空字符串
                            value: inputs[2].value || '',
                            // 保存复选框状态
                            enabled: isEnabled,
                            // 保存备注
                            remark: inputs[3].value || ''
                        };
                    }
                });
                body = { type: 'form', data: formData };
            } else if (bodyType === 'formdata') {
                const formDataItems = [];
                docSelectAll('.formdata-row').forEach(row => {
                    const key = row.querySelector('.formdata-key').value;
                    const type = row.querySelector('.formdata-type').value;
                    const isEnabled = row.querySelector('input[type="checkbox"]').checked;
                    // 只要有key就保存
                    if (key) {
                        const value = type === 'text' ? (row.querySelector('.text-input').value || '') : null;
                        const remarkInput = row.querySelector('.formdata-remark');
                        formDataItems.push({
                            key,
                            type,
                            value,
                            enabled: isEnabled,
                            remark: remarkInput ? remarkInput.value : ''
                        });
                    }
                });
                body = { type: 'formdata', data: formDataItems };
            } else if (bodyType === 'json') {
                const jsonBodyItems = [];
                docSelectAll('#jsonBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    jsonBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'json', data: jsonBodyItems };
            } else if (bodyType === 'text') {
                const textBodyItems = [];
                docSelectAll('#textBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    textBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'text', data: textBodyItems };
            } else if (bodyType === 'binary') {
                const binaryBodyItems = [];
                docSelectAll('#binaryBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const fileInput = row.querySelector('input[type="file"]');
                    const remark = row.querySelector('.body-remark').value;
                    // 对于文件，我们只能保存文件名，不能保存文件内容
                    const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    binaryBodyItems.push({
                        fileName,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'binary', data: binaryBodyItems };
            } else if (bodyType === 'websocket') {
                const wsBodyItems = [];
                docSelectAll('#wsBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const type = row.querySelector('.ws-body-type').value;
                    let value = '';
                    if (type === 'file') {
                        const fileInput = row.querySelector('.ws-body-file');
                        value = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    } else {
                        value = row.querySelector('.ws-body-text').value;
                    }
                    const remark = row.querySelector('.body-remark').value;
                    wsBodyItems.push({ type, value, selected: isSelected, remark });
                });
                body = { type: 'websocket', data: wsBodyItems };
            } else if (bodyType !== 'none') {
                // 对于其他类型的请求体，尝试从多行结构中获取
                body = { type: bodyType, data: byId('requestBody').value };
            }

            const historyItem = {
                method,
                url,
                headers,
                body,
                hooks: HookEngine.getHookScripts(),
                timestamp: new Date().toISOString()
            };

            // 获取现有历史记录
            let history = StorageManager.get('requestHistory', []);

            // 添加新记录到开头
            history.unshift(historyItem);

            // 限制历史记录数量
            if (history.length > MAX_HISTORY_ITEMS) {
                history = history.slice(0, MAX_HISTORY_ITEMS);
            }

            // 保存回localStorage
            StorageManager.set('requestHistory', history);

            // 更新显示
            updateHistoryDisplay();
        }

        /**
         * 从历史记录加载请求
         * 将历史记录中的请求信息恢复到当前界面
         * @param {Object} historyItem - 历史记录项
         */
        function loadRequestFromHistory(historyItem) {
            // 添加数据有效性检查
            if (!historyItem || typeof historyItem !== 'object') {
                console.error('无效的历史记录数据');
                return;
            }

            try {
                // 设置请求方法和URL
                byId('httpMethod').value = historyItem.method || 'GET';
                byId('url').value = historyItem.url || '';

                // 设置请求头
                const headersList = byId('headersList');
                headersList.innerHTML = '';
                if (historyItem.headers && typeof historyItem.headers === 'object') {
                    Object.entries(historyItem.headers).forEach(([key, headerData]) => {
                        // 添加键值有效性检查
                        if (key) {
                            const headerRow = document.createElement('div');
                            headerRow.className = 'header-row';
                            const isEnabled = typeof headerData === 'object' ? headerData.enabled : true;
                            const value = typeof headerData === 'object' ? headerData.value : headerData;
                            headerRow.innerHTML = `
                                <input type="checkbox" ${isEnabled ? 'checked' : ''}>
                                <input type="text" placeholder="Header名称" value="${key}"/>
                                <input type="text" placeholder="Header值" value="${value}"/>
                                <input type="text" placeholder="备注" class="header-remark input-remark" value="${headerData.remark}"/>
                                <button class="remove-btn" onclick="removeHeader(this)">删除</button>
                            `;
                            headersList.appendChild(headerRow);
                        }
                    });
                }
                if (!headersList.children.length) {
                    // 添加一个空的请求头行
                    addHeader();
                }

                // 设置请求体
                if (historyItem.body && typeof historyItem.body === 'object') {
                    const bodyType = historyItem.body.type;
                    const bodyTypeRadio = document.querySelector(`input[name="bodyType"][value="${bodyType}"]`);
                    if (bodyTypeRadio) {
                        bodyTypeRadio.checked = true;
                        updateBodyType(bodyType);

                        if (bodyType === 'form' && historyItem.body.data && typeof historyItem.body.data === 'object') {
                            const formRows = byId('formRows');
                            formRows.innerHTML = '';
                            Object.entries(historyItem.body.data).forEach(([key, formData]) => {
                                // 添加键值有效性检查
                                if (key) {
                                    const formRow = document.createElement('div');
                                    formRow.className = 'header-row';
                                    const isEnabled = typeof formData === 'object' ? formData.enabled : true;
                                    const value = typeof formData === 'object' ? formData.value : formData;
                                    formRow.innerHTML = `
                                        <input type="checkbox" ${isEnabled ? 'checked' : ''}>
                                        <input type="text" placeholder="参数名称" value="${key}"/>
                                        <input type="text" placeholder="参数值" value="${value}"/>
                                        <input type="text" placeholder="备注" class="header-remark input-remark" value="${formData.remark}"/>
                                        <button class="remove-btn" onclick="removeFormRow(this)">删除</button>
                                    `;
                                    formRows.appendChild(formRow);
                                }
                            });
                        } else if (bodyType === 'formdata' && Array.isArray(historyItem.body.data)) {
                            const formDataRows = byId('formDataRows');
                            formDataRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                // 添加数据有效性检查
                                if (item && typeof item === 'object' && item.key) {
                                    const row = createFormDataRow();
                                    row.querySelector('input[type="checkbox"]').checked = item.enabled !== false;
                                    row.querySelector('.formdata-key').value = item.key;
                                    const typeSelect = row.querySelector('.formdata-type');
                                    typeSelect.value = item.type || 'text';
                                    if (item.type === 'text' && item.value !== undefined) {
                                        row.querySelector('.text-input').value = item.value;
                                    }
                                    // 备注赋值
                                    const remarkInput = row.querySelector('.formdata-remark');
                                    if (remarkInput) remarkInput.value = item.remark || '';
                                    handleTypeChange(typeSelect);
                                    formDataRows.appendChild(row);
                                }
                            });
                        } else if (bodyType === 'json' && Array.isArray(historyItem.body.data)) {
                            const jsonBodyRows = byId('jsonBodyRows');
                            jsonBodyRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                if (item && typeof item === 'object') {
                                    const row = createJsonBodyRow();
                                    row.querySelector('input[type="radio"]').checked = item.selected || false;
                                    row.querySelector('textarea').value = item.content || '';
                                    row.querySelector('.body-remark').value = item.remark || '';
                                    jsonBodyRows.appendChild(row);
                                }
                            });
                        } else if (bodyType === 'text' && Array.isArray(historyItem.body.data)) {
                            const textBodyRows = byId('textBodyRows');
                            textBodyRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                if (item && typeof item === 'object') {
                                    const row = createTextBodyRow();
                                    row.querySelector('input[type="radio"]').checked = item.selected || false;
                                    row.querySelector('textarea').value = item.content || '';
                                    row.querySelector('.body-remark').value = item.remark || '';
                                    textBodyRows.appendChild(row);
                                }
                            });
                        } else if (bodyType === 'binary' && Array.isArray(historyItem.body.data)) {
                            const binaryBodyRows = byId('binaryBodyRows');
                            binaryBodyRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                if (item && typeof item === 'object') {
                                    const row = createBinaryBodyRow();
                                    row.querySelector('input[type="radio"]').checked = item.selected || false;
                                    row.querySelector('.body-remark').value = item.remark || '';
                                    // 注意：文件内容无法恢复，只能显示文件名
                                    binaryBodyRows.appendChild(row);
                                }
                            });
                        } else if (['json', 'text'].includes(bodyType) && historyItem.body.data !== undefined) {
                            byId('requestBody').value = historyItem.body.data;
                        }
                    }
                } else {
                    // 如果没有请求体，设置为默认值
                    const noneRadio = document.querySelector('input[name="bodyType"][value="none"]');
                    if (noneRadio) {
                        noneRadio.checked = true;
                        updateBodyType('none');
                    }
                }

                // 加载Hook脚本
                if (historyItem.hooks) {
                    HookEngine.setHookScripts(historyItem.hooks);
                }
            } catch (error) {
                console.error('加载请求数据时出错:', error);
                alert('加载请求数据时出错，请检查数据格式是否正确');
            }
        }

        /**
         * 更新历史记录显示
         * 从localStorage读取历史记录并在页面上显示
         */
        function updateHistoryDisplay() {
            const historyList = byId('historyList');
            const history = StorageManager.get('requestHistory', []);

            historyList.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleString('zh-CN');
                // 将历史记录项存储在一个自定义属性中
                const safeItem = JSON.stringify(item).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                return `
                    <div class="history-item">
                        <div class="history-time">${formattedDate}</div>
                        <div>
                            <span class="history-method">${item.method}</span>
                            <span class="history-url">${item.url}</span>
                        </div>
                        <button class="history-load-btn" data-history='${safeItem}'>加载请求</button>
                    </div>
                `;
            }).join('');

            // 为所有加载按钮添加事件监听器
            docSelectAll('.history-load-btn').forEach(button => {
                button.addEventListener('click', function () {
                    try {
                        if (!this.dataset.history && !this.dataset.api) {
                            console.error('没有找到历史记录数据');
                            return;
                        }
                        const historyItem = JSON.parse(this.dataset.history || this.dataset.api);
                        if (!historyItem || typeof historyItem !== 'object') {
                            console.error('无效的历史记录数据');
                            return;
                        }
                        loadRequestFromHistory(historyItem);
                    } catch (error) {
                        console.error('解析历史记录数据时出错:', error);
                        alert('加载历史记录失败，数据格式可能已损坏');
                    }
                });
            });
        }

        /**
         * 清空所有历史记录
         * 删除localStorage中的所有历史记录
         */
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可撤销。')) {
                StorageManager.remove('requestHistory');
                updateHistoryDisplay();
            }
        }

        /**
         * 导出历史记录
         * 将历史记录导出为JSON文件
         */
        function exportHistory() {
            const history = StorageManager.get('requestHistory', []);
            if (history.length === 0) {
                return alert('历史记录为空，无需导出');
            }

            const dataStr = JSON.stringify(history, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'history_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 导入历史记录
         * 从JSON文件导入历史记录
         */
        function importHistory() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const history = JSON.parse(content);

                        // 数据有效性检查
                        if (!Array.isArray(history)) {
                            throw new Error('导入的历史记录数据格式不正确');
                        }

                        // 限制导入的历史记录数量
                        const MAX_IMPORT_ITEMS = 50;
                        if (history.length > MAX_IMPORT_ITEMS) {
                            if (!confirm(`导入的历史记录项超过${MAX_IMPORT_ITEMS}条，是否继续？`)) {
                                return;
                            }
                        }

                        // 获取现有历史记录
                        let existingHistory = StorageManager.get('requestHistory', []);

                        // 合并历史记录
                        const mergedHistory = [...existingHistory, ...history];

                        // 去重，保留最新的记录
                        const uniqueHistory = Array.from(new Map(mergedHistory.map(item => [item.url + JSON.stringify(item.headers), item])).values());

                        // 限制历史记录数量
                        const finalHistory = uniqueHistory.slice(-MAX_HISTORY_ITEMS);

                        // 保存到localStorage
                        StorageManager.set('requestHistory', finalHistory);

                        alert('历史记录导入成功');
                        updateHistoryDisplay();
                    } catch (error) {
                        alert('导入历史记录时发生错误: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 保存当前请求到接口列表
         * 将当前请求保存到选中的接口集合中
         */
        function saveToApis() {
            const name = prompt('请输入接口名称：');
            if (!name) return;

            const method = byId('httpMethod').value;
            const url = byId('url').value;
            const bodyType = getBodyType();

            // 获取请求头
            const headers = {};
            docSelectAll('#headersList .header-row').forEach(row => {
                const inputs = row.getElementsByTagName('input');
                const isEnabled = inputs[0].checked;
                if (inputs[1].value) {
                    headers[inputs[1].value] = {
                        value: inputs[2].value || '',
                        enabled: isEnabled,
                        remark: inputs[3].value || ''
                    };
                }
            });

            // 获取请求体
            let body = null;
            if (bodyType === 'form') {
                const formData = {};
                docSelectAll('#formRows .header-row').forEach((row) => {
                    const inputs = row.getElementsByTagName('input');
                    const isEnabled = inputs[0].checked;
                    if (inputs[1].value) {
                        formData[inputs[1].value] = {
                            value: inputs[2].value || '',
                            enabled: isEnabled,
                            remark: inputs[3].value || ''
                        };
                    }
                });
                body = { type: 'form', data: formData };
            } else if (bodyType === 'formdata') {
                const formDataItems = [];
                docSelectAll('.formdata-row').forEach(row => {
                    const key = row.querySelector('.formdata-key').value;
                    const type = row.querySelector('.formdata-type').value;
                    const isEnabled = row.querySelector('input[type="checkbox"]').checked;
                    if (key) {
                        const value = type === 'text' ? (row.querySelector('.text-input').value || '') : null;
                        const remarkInput = row.querySelector('.formdata-remark');
                        formDataItems.push({
                            key,
                            type,
                            value,
                            enabled: isEnabled,
                            remark: remarkInput ? remarkInput.value : ''
                        });
                    }
                });
                body = { type: 'formdata', data: formDataItems };
            } else if (bodyType === 'json') {
                const jsonBodyItems = [];
                docSelectAll('#jsonBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    jsonBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'json', data: jsonBodyItems };
            } else if (bodyType === 'text') {
                const textBodyItems = [];
                docSelectAll('#textBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    textBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'text', data: textBodyItems };
            } else if (bodyType === 'binary') {
                const binaryBodyItems = [];
                docSelectAll('#binaryBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const fileInput = row.querySelector('input[type="file"]');
                    const remark = row.querySelector('.body-remark').value;
                    // 对于文件，我们只能保存文件名，不能保存文件内容
                    const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    binaryBodyItems.push({
                        fileName,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'binary', data: binaryBodyItems };
            } else if (bodyType === 'websocket') {
                const wsBodyItems = [];
                docSelectAll('#wsBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const type = row.querySelector('.ws-body-type').value;
                    let value = '';
                    if (type === 'file') {
                        const fileInput = row.querySelector('.ws-body-file');
                        value = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    } else {
                        value = row.querySelector('.ws-body-text').value;
                    }
                    const remark = row.querySelector('.body-remark').value;
                    wsBodyItems.push({ type, value, selected: isSelected, remark });
                });
                body = { type: 'websocket', data: wsBodyItems };
            } else if (bodyType !== 'none') {
                body = { type: bodyType, data: byId('requestBody').value };
            }

            const apiItem = {
                name,
                method,
                url,
                headers,
                body,
                hooks: HookEngine.getHookScripts(),
                timestamp: new Date().toISOString()
            };

            // 选择集合
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (!collection) {
                collection = { name: current, apis: [] };
                collections.push(collection);
            }
            collection.apis.unshift(apiItem);
            setApiCollections(collections);
            updateApisDisplay();
            switchPanelTab('apis');
        }

        /**
         * 更新接口列表显示
         * 从localStorage读取接口列表并在页面上显示
         */
        function updateApisDisplay() {
            const apisList = byId('apisList');
            const collections = getApiCollections();
            const current = getCurrentCollectionName();
            const collection = collections.find(c => c.name === current);
            const apis = collection ? collection.apis : [];
            apisList.innerHTML = apis.map((item, index) => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleString('zh-CN');
                const safeItem = JSON.stringify(item).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                return `
                    <div class="history-item">
                        <div class="history-time">${formattedDate}</div>
                        <div>
                            <strong>${item.name}</strong><br>
                            <span class="history-method">${item.method}</span>
                            <span class="history-url">${item.url}</span>
                        </div>
                        <button class="history-load-btn" data-api='${safeItem}'>加载请求</button>
                        <button class="remove-btn" onclick="removeApi(${index})">删除</button>
                    </div>
                `;
            }).join('');
            docSelectAll('#apisList .history-load-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const apiItem = JSON.parse(this.dataset.api);
                    loadRequestFromHistory(apiItem);
                });
            });
            updateApiCollectionSelect();
        }

        /**
         * 删除接口
         * @param {number} index - 要删除的接口索引
         */
        function removeApi(index) {
            if (!confirm('确定要删除这个接口吗？此操作不可撤销。')) {
                return;
            }
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (collection && index >= 0 && index < collection.apis.length) {
                collection.apis.splice(index, 1);
                setApiCollections(collections);
                updateApisDisplay();
            }
        }

        /**
         * 清空当前集合下的所有接口
         */
        function clearApis() {
            if (!confirm('确定要清空当前集合下所有接口吗？此操作不可撤销。')) {
                return;
            }
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (collection) {
                collection.apis = [];
                setApiCollections(collections);
                updateApisDisplay();
            }
        }

        /**
         * 导出接口列表
         * 将当前集合的接口列表导出为JSON文件
         */
        function exportApis() {
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (!collection || collection.apis.length === 0) {
                return alert('当前集合接口列表为空，无需导出');
            }
            const dataStr = JSON.stringify(collection.apis, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${current}_apis_export.json`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 导入接口列表
         * 从JSON文件导入接口列表
         */
        function importApis() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const apis = JSON.parse(content);
                        if (!Array.isArray(apis)) {
                            throw new Error('导入的接口数据格式不正确');
                        }
                        let collections = getApiCollections();
                        let current = getCurrentCollectionName();
                        let collection = collections.find(c => c.name === current);
                        if (!collection) {
                            collection = { name: current, apis: [] };
                            collections.push(collection);
                        }
                        // 合并接口列表
                        const mergedApis = [...collection.apis, ...apis];
                        // 去重，保留最新的记录
                        const uniqueApis = Array.from(new Map(mergedApis.map(item => [item.name, item])).values());
                        collection.apis = uniqueApis;
                        setApiCollections(collections);
                        alert('接口列表导入成功');
                        updateApisDisplay();
                    } catch (error) {
                        alert('导入接口列表时发生错误: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 添加变量行
         * 在变量表格中添加一个新的变量行
         */
        function addVariableRow() {
            const tbody = byId('variablesTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" checked></td>
                <td><input type="text" class="var-name"></td>
                <td><input type="text" class="var-value"></td>
                <td><button class="remove-btn" onclick="removeVariableRow(this)">删除</button></td>
            `;
            tbody.appendChild(row);
        }

        /**
         * 删除变量行
         * @param {HTMLElement} button - 删除按钮元素
         */
        function removeVariableRow(button) {
            button.closest('tr').remove();
        }

        /**
         * 保存变量配置
         * 将变量表格中的内容保存到localStorage
         */
        function saveVariables() {
            const rows = docSelectAll('#variablesTableBody tr');
            const envConf = [];

            rows.forEach((row, index) => {
                const enable = row.querySelector('input[type="checkbox"]').checked;
                const name = row.querySelector('.var-name').value.trim();
                const value = row.querySelector('.var-value').value.trim();

                // 检查变量名和值是否包含非法字符
                if (name.includes('{') || name.includes('}') || value.includes('{') || value.includes('}')) {
                    alert('变量名和变量值不能包含 { 或 } 字符');
                    return;
                }

                // 添加到配置数组
                envConf.push({
                    row_id: index + 1,
                    enable: enable,
                    env_name: name,
                    env_value: value
                });
            });

            // 保存到localStorage
            StorageManager.set('env_conf', envConf);

            alert('变量保存成功');
        }

        /**
         * 加载变量配置
         * 从localStorage读取变量配置并显示在表格中
         */
        function loadVariables() {
            const envConf = StorageManager.get('env_conf', []);
            const tbody = byId('variablesTableBody');
            tbody.innerHTML = '';

            envConf.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" ${item.enable ? 'checked' : ''}></td>
                    <td><input type="text" class="var-name" value="${item.env_name}"></td>
                    <td><input type="text" class="var-value" value="${item.env_value}"></td>
                    <td><button class="remove-btn" onclick="removeVariableRow(this)">删除</button></td>
                `;
                tbody.appendChild(row);
            });

            if (envConf.length === 0) {
                addVariableRow();
            }
        }

        /**
         * 清空所有变量
         * 删除localStorage中的所有变量配置
         */
        function clearVariables() {
            if (confirm('确定要清空所有变量吗？此操作不可撤销。')) {
                StorageManager.remove('env_conf');
                loadVariables();
            }
        }

        /**
         * 导出变量配置
         * 将变量配置导出为JSON文件
         */
        function exportVariables() {
            const envConf = StorageManager.get('env_conf', []);
            if (envConf.length === 0) {
                return alert('没有可导出的变量');
            }

            const dataStr = JSON.stringify(envConf, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'variables_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 导入变量配置
         * 从JSON文件导入变量配置
         */
        function importVariables() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const envConf = JSON.parse(content);

                        if (!Array.isArray(envConf)) {
                            throw new Error('导入的变量数据格式不正确');
                        }

                        StorageManager.set('env_conf', envConf);
                        loadVariables();
                        alert('变量导入成功');
                    } catch (error) {
                        alert('导入变量时发生错误: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 替换变量
         * 将文本中的{{变量名}}替换为对应的变量值（只替换启用的变量）
         * @param {string} text - 要替换的文本
         * @returns {string} 替换后的文本
         */
        function replaceVariables(text) {
            if (!text) return text;

            const envConf = StorageManager.get('env_conf', []);
            let result = text;

            envConf.filter(v => v.enable !== false).forEach(({ env_name, env_value }) => {
                const pattern = new RegExp(`{{${env_name}}}`, 'g');
                result = result.replace(pattern, env_value);
            });

            return result;
        }

        /**
         * 添加全局请求头行
         * 在全局请求头表格中添加一个新的请求头行
         */
        function addGlobalHeaderRow() {
            const tbody = byId('globalHeadersTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" checked></td>
                <td><input type="text" class="header-name"></td>
                <td><input type="text" class="header-value"></td>
                <td><button class="remove-btn" onclick="removeGlobalHeaderRow(this)">删除</button></td>
            `;
            tbody.appendChild(row);
        }

        /**
         * 删除全局请求头行
         * @param {HTMLElement} button - 删除按钮元素
         */
        function removeGlobalHeaderRow(button) {
            button.closest('tr').remove();
        }

        /**
         * 保存全局请求头配置
         * 将全局请求头表格中的内容保存到localStorage
         */
        function saveGlobalHeaders() {
            const rows = docSelectAll('#globalHeadersTableBody tr');
            const headerConf = [];

            rows.forEach((row, index) => {
                const enable = row.querySelector('input[type="checkbox"]').checked;
                const name = row.querySelector('.header-name').value.trim();
                const value = row.querySelector('.header-value').value.trim();

                // 添加到配置数组
                headerConf.push({
                    row_id: index + 1,
                    enable: enable,
                    header_name: name,
                    header_value: value
                });
            });

            // 保存到localStorage
            StorageManager.set('header_conf', headerConf);

            alert('全局请求头保存成功');
        }

        /**
         * 加载全局请求头配置
         * 从localStorage读取全局请求头配置并显示在表格中
         */
        function loadGlobalHeaders() {
            const headerConf = StorageManager.get('header_conf', []);
            const tbody = byId('globalHeadersTableBody');
            tbody.innerHTML = '';

            headerConf.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" ${item.enable ? 'checked' : ''}></td>
                    <td><input type="text" class="header-name" value="${item.header_name}"></td>
                    <td><input type="text" class="header-value" value="${item.header_value}"></td>
                    <td><button class="remove-btn" onclick="removeGlobalHeaderRow(this)">删除</button></td>
                `;
                tbody.appendChild(row);
            });

            if (headerConf.length === 0) {
                addGlobalHeaderRow();
            }
        }

        /**
         * 清空所有全局请求头
         * 删除localStorage中的所有全局请求头配置
         */
        function clearGlobalHeaders() {
            if (confirm('确定要清空所有全局请求头吗？此操作不可撤销。')) {
                StorageManager.remove('header_conf');
                loadGlobalHeaders();
            }
        }

        /**
         * 导出全局请求头配置
         * 将全局请求头配置导出为JSON文件
         */
        function exportGlobalHeaders() {
            const headerConf = StorageManager.get('header_conf', []);
            if (headerConf.length === 0) {
                return alert('没有可导出的全局请求头');
            }

            const dataStr = JSON.stringify(headerConf, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'global_headers_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 导入全局请求头配置
         * 从JSON文件导入全局请求头配置
         */
        function importGlobalHeaders() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const headerConf = JSON.parse(content);

                        if (!Array.isArray(headerConf)) {
                            throw new Error('导入的全局请求头数据格式不正确');
                        }

                        StorageManager.set('header_conf', headerConf);
                        loadGlobalHeaders();
                        alert('全局请求头导入成功');
                    } catch (error) {
                        alert('导入全局请求头时发生错误: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 获取全局请求头
         * 从localStorage读取全局请求头并返回对象（只返回启用的请求头）
         * @returns {Object} 全局请求头对象
         */
        function getGlobalHeaders() {
            const headerConf = StorageManager.get('header_conf', []);
            const headers = {};
            headerConf.filter(h => h.enable !== false).forEach(({ header_name, header_value }) => {
                const key = replaceVariables(header_name).trim();
                const value = replaceVariables(header_value).trim();
                headers[key] = value;
            });
            return headers;
        }

        /**
         * 打开设置对话框
         * 显示请求配置设置对话框
         */
        function openSettings() {
            byId('dialogOverlay').style.display = 'block';
            byId('settingsDialog').style.display = 'block';
            loadSettings();
        }

        /**
         * 关闭设置对话框
         * 隐藏请求配置设置对话框
         */
        function closeSettings() {
            byId('dialogOverlay').style.display = 'none';
            byId('settingsDialog').style.display = 'none';
        }

        /**
         * 加载设置到对话框
         * 从localStorage读取当前设置并显示在对话框中
         */
        function loadSettings() {
            const currentSettings = getRequestSettings();
            byId('settingDefaultProtocol').value = currentSettings.default_protocol || 'http';
            byId('settingVerifySSL').value = currentSettings.verify_ssl;
            byId('settingFollowRedirect').value = currentSettings.follow_redirect;
            byId('settingTimeout').value = currentSettings.timeout;
            byId('settingRetryCount').value = currentSettings.retry_count;
            byId('settingRetryDelay').value = currentSettings.retry_delay;
            byId('settingSseEventTypes').value = currentSettings.sse_event_types || '';

            byId('settingCache').value = currentSettings.cache;
            byId('settingMode').value = currentSettings.mode;
            byId('settingCredentials').value = currentSettings.credentials;
            byId('settingRedirect').value = currentSettings.redirect;
            byId('settingReferrerPolicy').value = currentSettings.referrerPolicy;
            byId('settingReferrer').value = currentSettings.referrer === 'custom' ? 'custom' : currentSettings.referrer;
            byId('settingReferrerCustom').value = currentSettings.referrer !== 'about:client' && currentSettings.referrer !== '' ? currentSettings.referrer : '';
            byId('settingIntegrity').value = currentSettings.integrity;
            byId('settingKeepalive').value = currentSettings.keepalive.toString();
            handleReferrerChange();
        }

        /**
         * 保存设置
         * 将对话框中的设置保存到localStorage
         */
        function saveSettings() {
            const settings = {
                default_protocol: byId('settingDefaultProtocol').value,
                verify_ssl: byId('settingVerifySSL').value,
                follow_redirect: byId('settingFollowRedirect').value,
                timeout: byId('settingTimeout').value,
                retry_count: byId('settingRetryCount').value,
                retry_delay: byId('settingRetryDelay').value,
                sse_event_types: byId('settingSseEventTypes').value,

                cache: byId('settingCache').value,
                mode: byId('settingMode').value,
                credentials: byId('settingCredentials').value,
                redirect: byId('settingRedirect').value,
                referrerPolicy: byId('settingReferrerPolicy').value,
                referrer: byId('settingReferrer').value === 'custom'
                    ? byId('settingReferrerCustom').value
                    : byId('settingReferrer').value,
                integrity: byId('settingIntegrity').value,
                keepalive: byId('settingKeepalive').value === 'true'
            };
            StorageManager.set('requestSettings', settings);
            closeSettings();
        }

        /**
         * 获取请求设置
         * 从localStorage读取请求设置，如果没有则使用默认值
         * @returns {Object} 请求设置对象
         */
        function getRequestSettings() {
            const settings = StorageManager.get('requestSettings', {});
            const defaultSettings = {
                cache: 'default',
                mode: 'cors',
                credentials: 'same-origin',
                redirect: 'follow',
                referrerPolicy: 'no-referrer-when-downgrade',
                referrer: 'about:client',
                integrity: '',
                keepalive: false,
                default_protocol: 'http',
                verify_ssl: 'N',
                follow_redirect: 'N',
                timeout: '0',
                retry_count: '0',
                retry_delay: '0',
                sse_event_types: ''
            };
            return { ...defaultSettings, ...settings };
        }

        /**
         * 处理Referrer设置变化
         * 当Referrer选择为自定义时显示自定义输入框
         */
        function handleReferrerChange() {
            const referrerSelect = byId('settingReferrer');
            const customInput = byId('settingReferrerCustom');
            customInput.style.display = referrerSelect.value === 'custom' ? 'block' : 'none';
        }

        /**
         * 切换侧边栏面板标签页
         * @param {string} tab - 标签页名称
         */
        function switchPanelTab(tab) {
            docSelectAll('.panel-tab').forEach(tabElement => tabElement.classList.remove('active'));
            docSelectAll('.panel-content').forEach(contentElement => contentElement.classList.remove('active'));

            const activeTab = document.querySelector(`.panel-tab[onclick="switchPanelTab('${tab}')"]`);
            const activeContent = byId(`${tab}Panel`);

            activeTab.classList.add('active');
            activeContent.classList.add('active');

            // 保存最后选中的标签页
            StorageManager.set('lastActiveTab', tab);
        }

        /**
         * 导出所有配置
         * 将历史记录、接口集合、变量、全局请求头、请求设置导出为JSON文件
         */
        function exportAllConfig() {
            const config = {
                history: StorageManager.get('requestHistory', []),
                apiCollections: StorageManager.get('apiCollections', []),
                variables: StorageManager.get('env_conf', []),
                globalHeaders: StorageManager.get('header_conf', []),
                requestSettings: StorageManager.get('requestSettings', {})
            };

            const dataStr = JSON.stringify(config, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'curl_config_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 导入所有配置
         * 从JSON文件导入所有配置
         */
        function importAllConfig() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const config = JSON.parse(content);

                        // 验证配置格式
                        if (typeof config !== 'object') {
                            throw new Error('导入的配置文件格式不正确');
                        }

                        // 导入历史记录
                        if (Array.isArray(config.history)) {
                            StorageManager.set('requestHistory', config.history);
                        }

                        // 导入接口集合
                        if (Array.isArray(config.apiCollections)) {
                            StorageManager.set('apiCollections', config.apiCollections);
                            // 默认选中第一个集合
                            if (config.apiCollections.length > 0) {
                                setCurrentCollectionName(config.apiCollections[0].name);
                            }
                        }

                        // 导入变量配置
                        if (Array.isArray(config.variables)) {
                            StorageManager.set('env_conf', config.variables);
                        }

                        // 导入全局请求头
                        if (Array.isArray(config.globalHeaders)) {
                            StorageManager.set('header_conf', config.globalHeaders);
                        }

                        // 导入请求配置
                        if (typeof config.requestSettings === 'object') {
                            StorageManager.set('requestSettings', config.requestSettings);
                        }

                        // 更新所有显示
                        updateHistoryDisplay();
                        updateApisDisplay();
                        loadVariables();
                        loadGlobalHeaders();
                        loadSettings();
                        updateApiCollectionSelect();

                        alert('配置导入成功');
                    } catch (error) {
                        alert('导入配置时发生错误: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 获取所有接口集合
         * 从localStorage读取接口集合，如果不存在则自动迁移老数据或创建默认集合
         * @returns {Array} 接口集合数组
         */
        function getApiCollections() {
            let collections = StorageManager.get('apiCollections', []);
            // 兼容老数据迁移
            if (collections.length === 0) {
                let oldApis = StorageManager.get('savedApis', []);
                collections = [{ name: '默认集合', apis: oldApis }];
                StorageManager.set('apiCollections', collections);
                StorageManager.remove('savedApis');
            }
            // 如果依然没有集合，自动创建一个默认集合
            if (collections.length === 0) {
                collections = [{ name: '默认集合', apis: [] }];
                StorageManager.set('apiCollections', collections);
            }
            return collections;
        }

        /**
         * 保存所有接口集合到localStorage
         * @param {Array} collections - 接口集合数组
         */
        function setApiCollections(collections) {
            StorageManager.set('apiCollections', collections);
        }

        /**
         * 获取当前选中的接口集合名称
         * @returns {string} 当前集合名称
         */
        function getCurrentCollectionName() {
            return StorageManager.get('currentApiCollection', '默认集合');
        }

        /**
         * 设置当前选中的接口集合名称
         * @param {string} name - 集合名称
         */
        function setCurrentCollectionName(name) {
            StorageManager.set('currentApiCollection', name);
        }

        /**
         * 更新接口集合选择下拉框
         * 根据当前集合列表更新下拉框选项
         */
        function updateApiCollectionSelect() {
            const collections = getApiCollections();
            const select = byId('apiCollectionSelect');
            select.innerHTML = collections.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            // 选中当前集合
            let current = getCurrentCollectionName();
            if (!collections.some(c => c.name === current)) {
                // 如果当前集合不存在，默认选第一个
                current = collections.length > 0 ? collections[0].name : '';
                setCurrentCollectionName(current);
            }
            select.value = current;
        }

        /**
         * 切换接口集合
         * 当用户选择不同的接口集合时更新显示
         */
        function switchApiCollection() {
            const select = byId('apiCollectionSelect');
            setCurrentCollectionName(select.value);
            updateApisDisplay();
        }

        /**
         * 添加新的接口集合
         * 创建新的接口集合并设置为当前选中
         */
        function addApiCollection() {
            const name = prompt('请输入新集合名称：');
            if (!name) return;
            let collections = getApiCollections();
            if (collections.some(c => c.name === name)) {
                alert('集合名已存在');
                return;
            }
            collections.push({ name, apis: [] });
            setApiCollections(collections);
            setCurrentCollectionName(name);
            updateApiCollectionSelect();
            updateApisDisplay();
        }

        /**
         * 删除当前接口集合
         * 删除当前选中的接口集合，默认集合不能删除
         */
        function removeApiCollection() {
            const current = getCurrentCollectionName();
            if (current === '默认集合') {
                alert('默认集合不能删除');
                return;
            }
            if (!confirm('确定要删除集合及其所有接口吗？')) return;
            let collections = getApiCollections();
            collections = collections.filter(c => c.name !== current);
            setApiCollections(collections);
            setCurrentCollectionName('默认集合');
            updateApiCollectionSelect();
            updateApisDisplay();
        }

        let isAsideVisible = true;

        /**
         * 切换左侧边栏显示/隐藏
         * 点击按钮隐藏或显示左侧区域，右侧内容自动调整宽度
         */
        function toggleAside() {
            const aside = document.querySelector('.aside');
            const mainContent = document.querySelector('.main-content');
            const contentWrapper = document.querySelector('.content-wrapper');
            const toggleBtn = document.querySelector('.toggle-aside-btn');

            if (isAsideVisible) {
                aside.classList.add('aside-hidden');
                mainContent.classList.add('main-content-expanded');
                contentWrapper.classList.add('content-wrapper-expanded');
                toggleBtn.textContent = '▶';
            } else {
                aside.classList.remove('aside-hidden');
                mainContent.classList.remove('main-content-expanded');
                contentWrapper.classList.remove('content-wrapper-expanded');
                toggleBtn.textContent = '◀';
            }
            isAsideVisible = !isAsideVisible;
        }

        /**
         * 新建请求
         * 清空当前请求的所有内容，包括URL、请求头、请求体、响应等
         */
        function newRequest() {
            // 清空URL
            const urlInput = byId('url');
            if (urlInput) urlInput.value = '';

            // 清空请求头
            const headersList = byId('headersList');
            if (headersList) {
                headersList.innerHTML = '';
                addHeader();
            }

            // 清空多行请求体
            const jsonBodyRows = byId('jsonBodyRows');
            if (jsonBodyRows) {
                jsonBodyRows.innerHTML = '';
            }
            const textBodyRows = byId('textBodyRows');
            if (textBodyRows) {
                textBodyRows.innerHTML = '';
            }
            const binaryBodyRows = byId('binaryBodyRows');
            if (binaryBodyRows) {
                binaryBodyRows.innerHTML = '';
            }

            // 清空form表单
            const formRows = byId('formRows');
            if (formRows) {
                formRows.innerHTML = '';
                addFormRow();
            }

            // 清空formdata
            const formDataRows = byId('formDataRows');
            if (formDataRows) {
                formDataRows.innerHTML = '';
                addFormDataRow();
            }

            // 清空WebSocket消息体
            const wsBodyRows = byId('wsBodyRows');
            if (wsBodyRows) {
                wsBodyRows.innerHTML = '';
            }

            // 重置body类型为none
            const noneRadio = document.querySelector('input[name="bodyType"][value="none"]');
            if (noneRadio) {
                noneRadio.checked = true;
                updateBodyType('none');
            }

            // 清空响应信息
            clearResponse();
        }

        // JSON格式化高亮相关变量
        let formattedJson = '';
        let isJsonFormatted = false;

        /**
         * 格式化响应体中的JSON内容并高亮显示
         * 解析并格式化JSON字符串，渲染为高亮DOM结构
         * @returns {void}
         */
        function formatJsonResponse() {
            const responseBody = byId('responseBody');
            const jsonFormattedContainer = byId('jsonFormattedContainer');
            const formatJsonBtn = byId('formatJsonBtn');
            const copyFormattedBtn = byId('copyFormattedBtn');

            if (!responseBody || !jsonFormattedContainer || !formatJsonBtn || !copyFormattedBtn) {
                console.error('JSON格式化所需元素不存在');
                return;
            }

            try {
                const rawJson = responseBody.value.trim();
                if (!rawJson) {
                    alert('没有JSON内容可格式化');
                    return;
                }

                const jsonObj = JSON.parse(rawJson);
                formattedJson = JSON.stringify(jsonObj, null, 4);

                // 渲染格式化后的JSON
                renderJsonWithDom(jsonObj);

                // 显示格式化容器，隐藏原始textarea
                jsonFormattedContainer.style.display = 'block';
                responseBody.style.display = 'none';
                copyFormattedBtn.style.display = 'inline-block';
                isJsonFormatted = true;

            } catch (error) {
                alert('JSON格式错误: ' + (error.message || error));
                console.error('JSON格式化失败:', error);
            }
        }

        /**
         * 复制格式化后的JSON字符串到剪贴板
         * @returns {void}
         */
        /**
         * 复制格式化JSON到剪贴板
         */
        async function copyFormattedJson() {
            if (!formattedJson) {
                alert("请先格式化JSON数据");
                return;
            }

            const copyFormattedBtn = byId('copyFormattedBtn');

            try {
                if (typeof navigator !== 'undefined' && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    await navigator.clipboard.writeText(formattedJson);

                    if (copyFormattedBtn) {
                        copyFormattedBtn.textContent = "✓ 已复制!";
                        setTimeout(() => {
                            if (copyFormattedBtn) {
                                copyFormattedBtn.textContent = "复制格式化JSON";
                            }
                        }, 2000);
                    }
                    console.log('格式化JSON已复制到剪贴板');
                } else {
                    console.warn('剪贴板API不可用');
                    alert("复制失败，请手动复制内容");
                }
            } catch (err) {
                console.error('复制格式化JSON失败:', err);
                alert("复制失败，请手动复制内容");
            }
        }

        /**
         * JSON格式化:使用DOM渲染JSON
         * 将JSON数据渲染为可折叠的DOM结构，支持展开/收起功能
         * @param {any} data - 要渲染的JSON数据
         */
        function renderJsonWithDom(data) {
            const jsonFormattedContainer = byId('jsonFormattedContainer');
            jsonFormattedContainer.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'json-formatted';
            processValue(container, data);
            jsonFormattedContainer.appendChild(container);
        }

        /**
         * JSON格式化:处理不同类型的值
         * 根据数据类型创建对应的DOM元素，支持null、数组、对象、字符串、数字、布尔值
         * @param {HTMLElement} parent - 父元素
         * @param {any} data - 要处理的数据
         */
        function processValue(parent, data) {
            if (data === null) {
                createAndAppendSpan(parent, 'null', 'json-null');
            } else if (Array.isArray(data)) {
                processArray(parent, data);
            } else if (typeof data === 'object') {
                processObject(parent, data);
            } else if (typeof data === 'string') {
                createAndAppendSpan(parent, `"${data}"`, 'json-string');
            } else if (typeof data === 'number') {
                createAndAppendSpan(parent, data, 'json-number');
            } else if (typeof data === 'boolean') {
                createAndAppendSpan(parent, data ? 'true' : 'false', 'json-boolean');
            }
        }

        /**
         * JSON格式化:处理数组
         * 创建可折叠的数组DOM结构，支持展开/收起功能
         * @param {HTMLElement} parent - 父元素
         * @param {Array} arr - 要处理的数组
         */
        function processArray(parent, arr) {
            if (arr.length === 0) {
                createAndAppendSpan(parent, '[]', 'json-bracket');
                return;
            }
            // 折叠按钮
            const arrow = document.createElement('span');
            arrow.textContent = '▼';
            arrow.className = 'json-arrow';
            // 括号
            const bracketSpan = document.createElement('span');
            bracketSpan.textContent = '[';
            bracketSpan.className = 'json-bracket';
            // 容器
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'json-container';
            arr.forEach((item, i) => {
                const itemDiv = document.createElement('div');
                processValue(itemDiv, item);
                if (i < arr.length - 1) {
                    createAndAppendSpan(itemDiv, ',', 'json-bracket');
                }
                itemsContainer.appendChild(itemDiv);
            });
            // 结束括号
            const endBracketDiv = document.createElement('div');
            const endBracketSpan = document.createElement('span');
            endBracketSpan.textContent = ']';
            endBracketSpan.className = 'json-bracket';
            endBracketDiv.appendChild(endBracketSpan);
            // 折叠逻辑
            arrow.onclick = function () {
                if (itemsContainer.style.display === 'none') {
                    itemsContainer.style.display = '';
                    endBracketDiv.style.display = '';
                    arrow.textContent = '▼';
                } else {
                    itemsContainer.style.display = 'none';
                    endBracketDiv.style.display = 'none';
                    arrow.textContent = '▶';
                }
            };
            // 组装
            const headerDiv = document.createElement('div');
            headerDiv.appendChild(arrow);
            headerDiv.appendChild(bracketSpan);
            parent.appendChild(headerDiv);
            parent.appendChild(itemsContainer);
            parent.appendChild(endBracketDiv);
        }

        /**
         * JSON格式化:处理对象
         * 创建可折叠的对象DOM结构，支持展开/收起功能
         * @param {HTMLElement} parent - 父元素
         * @param {Object} obj - 要处理的对象
         */
        function processObject(parent, obj) {
            const keys = Object.keys(obj);
            if (keys.length === 0) {
                createAndAppendSpan(parent, '{}', 'json-bracket');
                return;
            }
            // 折叠按钮
            const arrow = document.createElement('span');
            arrow.textContent = '▼';
            arrow.className = 'json-arrow';
            // 括号
            const bracketSpan = document.createElement('span');
            bracketSpan.textContent = '{';
            bracketSpan.className = 'json-bracket';
            // 属性容器
            const propsContainer = document.createElement('div');
            propsContainer.className = 'json-container';
            keys.forEach((key, i) => {
                const propDiv = document.createElement('div');
                createAndAppendSpan(propDiv, `"${key}":`, 'json-key');
                createAndAppendSpan(propDiv, ' ', null);
                processValue(propDiv, obj[key]);
                if (i < keys.length - 1) {
                    createAndAppendSpan(propDiv, ',', 'json-bracket');
                }
                propsContainer.appendChild(propDiv);
            });
            // 结束括号
            const endBracketDiv = document.createElement('div');
            const endBracketSpan = document.createElement('span');
            endBracketSpan.textContent = '}';
            endBracketSpan.className = 'json-bracket';
            endBracketDiv.appendChild(endBracketSpan);
            // 折叠逻辑
            arrow.onclick = function () {
                if (propsContainer.style.display === 'none') {
                    propsContainer.style.display = '';
                    endBracketDiv.style.display = '';
                    arrow.textContent = '▼';
                } else {
                    propsContainer.style.display = 'none';
                    endBracketDiv.style.display = 'none';
                    arrow.textContent = '▶';
                }
            };
            // 组装
            const headerDiv = document.createElement('div');
            headerDiv.appendChild(arrow);
            headerDiv.appendChild(bracketSpan);
            parent.appendChild(headerDiv);
            parent.appendChild(propsContainer);
            parent.appendChild(endBracketDiv);
        }

        /**
         * JSON格式化:创建并添加带样式的span
         * 创建带样式的span元素并添加到父元素中
         * @param {HTMLElement} parent - 父元素
         * @param {string} content - 内容
         * @param {string} className - CSS类名
         * @param {boolean} newLine - 是否换行
         */
        function createAndAppendSpan(parent, content, className, newLine = false) {
            const span = document.createElement('span');
            span.textContent = content;
            if (className) span.className = className;

            if (newLine) {
                const div = document.createElement('div');
                div.appendChild(span);
                parent.appendChild(div);
            } else {
                parent.appendChild(span);
            }
        }

        /**
         * SSE流式Fetch响应处理函数
         * 处理fetch返回的SSE流式响应，实时显示数据
         * @param {Response} response - fetch响应对象
         * @returns {Promise<void>}
         */
        async function handleSSEFetchResponse(response) {
            const responseInfo = byId('responseInfo');
            const responseBody = byId('responseBody');
            const responseHeadersTable = byId('responseHeaders')?.getElementsByTagName('tbody')[0];

            if (responseInfo) responseInfo.innerHTML = 'SSE流式响应中...';

            // 显示响应头
            if (responseHeadersTable) {
                responseHeadersTable.innerHTML = '';
                response.headers.forEach((value, key) => {
                    const row = responseHeadersTable.insertRow();
                    row.insertCell(0).textContent = key;
                    row.insertCell(1).textContent = value;
                });
            }

            if (responseBody) responseBody.value = '';

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let dataBuffer = '';
            let result = '';

            /**
             * 读取SSE流数据
             * 递归读取响应流并处理SSE事件
             */
            async function readStream() {
                try {
                    const { value, done } = await reader.read();

                    if (done) {
                        if (responseInfo) responseInfo.innerHTML = 'SSE流式响应已结束';
                        return;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    //console.log('收到数据块:', chunk);
                    dataBuffer += chunk;

                    // 处理SSE事件
                    const lines = dataBuffer.split('\n');
                    dataBuffer = lines.pop() || '';

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        // console.log('处理行:', trimmedLine);

                        // 显示所有非空行，不仅仅是data:开头的
                        if (trimmedLine) {
                            if (trimmedLine.startsWith('data:')) {
                                const data = trimmedLine.slice(5).trim();
                                if (data) {
                                    result += data + '\n';
                                    if (responseBody) responseBody.value = result;
                                }
                            } else {
                                // 显示非标准SSE格式的行
                                result += trimmedLine + '\n';
                                if (responseBody) responseBody.value = result;
                            }
                        }
                    }

                    readStream();
                } catch (err) {
                    console.error('SSE读取错误:', err);
                    if (responseInfo) responseInfo.innerHTML = 'SSE读取失败：' + err;
                }
            }

            readStream();
        }

        /**
         * 创建WebSocket消息体行
         * 创建一个包含radio选择、类型选择、消息体输入、备注和删除按钮的WebSocket消息体行
         * @returns {HTMLElement} 创建的WebSocket消息体行元素
         */
        function createWsBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="wsBodyRadio">
                <select class="ws-body-type">
                    <option value="text">文本</option>
                    <option value="binary">二进制(Base64)</option>
                    <option value="file">文件</option>
                </select>
                <div class="ws-body-content">
                    <textarea class="ws-body-text" placeholder="消息内容"></textarea>
                    <input type="file" class="ws-body-file file-input-ws">
                </div>
                <textarea class="body-remark" placeholder="备注"></textarea>
                <button class="remove-btn" type="button" onclick="removeWsBodyRow(this)">删除</button>
            `;
            // 类型切换
            const typeSelect = row.querySelector('.ws-body-type');
            const textArea = row.querySelector('.ws-body-text');
            const fileInput = row.querySelector('.ws-body-file');
            typeSelect.onchange = function () {
                if (this.value === 'file') {
                    textArea.style.display = 'none';
                    fileInput.style.display = 'block';
                } else {
                    textArea.style.display = 'block';
                    fileInput.style.display = 'none';
                }
            };
            return row;
        }

        /**
         * 添加WebSocket消息体行
         * 在WebSocket消息体容器中添加一个新的消息体行，如果是第一行则自动选中
         */
        function addWsBodyRow() {
            const container = byId('wsBodyRows');
            const row = createWsBodyRow();
            container.appendChild(row);
            // 如果是第一行，自动选中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 删除WebSocket消息体行
         * 删除指定的消息体行，如果删除的是选中的行且还有其他行，则选中第一行
         * @param {HTMLElement} btn - 删除按钮元素
         */
        function removeWsBodyRow(btn) {
            const row = btn.closest('.body-row');
            const container = byId('wsBodyRows');
            const wasSelected = row.querySelector('input[type="radio"]').checked;
            row.remove();
            if (wasSelected && container.children.length > 0) {
                container.children[0].querySelector('input[type="radio"]').checked = true;
            }
            if (container.children.length === 0) {
                addWsBodyRow();
            }
        }

        /**
         * 发送WebSocket消息体
         * 发送当前选中的WebSocket消息体行，根据类型处理（text直接发送，binary base64解码，file读取为二进制）
         * @returns {Promise<void>}
         */
        async function sendWsBody() {
            if (!currentWS || currentWS.readyState !== 1) {
                alert('WebSocket未连接');
                return;
            }
            const rows = docSelectAll('#wsBodyRows .body-row');
            let found = false;
            for (const row of rows) {
                if (row.querySelector('input[type="radio"]').checked) {
                    found = true;
                    const type = row.querySelector('.ws-body-type').value;
                    if (type === 'text') {
                        const val = row.querySelector('.ws-body-text').value;
                        currentWS.send(val);
                    } else if (type === 'binary') {
                        const val = row.querySelector('.ws-body-text').value;
                        try {
                            const bin = Uint8Array.from(atob(val), c => c.charCodeAt(0));
                            currentWS.send(bin);
                        } catch (e) {
                            alert('Base64解码失败');
                        }
                    } else if (type === 'file') {
                        const fileInput = row.querySelector('.ws-body-file');
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            const buf = await file.arrayBuffer();
                            currentWS.send(buf);
                        } else {
                            alert('请选择文件');
                        }
                    }
                    break;
                }
            }
            if (!found) alert('请选择要发送的消息行');
        }

        /**
         * 导出curl命令
         * 将当前请求转换为curl命令并复制到剪贴板
         */
        function exportCurlCommand() {
            const curlCommand = generateCurlCommand();
            if (!curlCommand) return;

            try {
                if (typeof navigator !== 'undefined' && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    navigator.clipboard.writeText(curlCommand).then(() => {
                        alert('已将curl命令复制到剪贴板！');
                    }).catch(() => {
                        prompt('复制以下的curl命令:', curlCommand);
                    });
                } else {
                    prompt('复制以下的curl命令:', curlCommand);
                }
            } catch (clipboardError) {
                prompt('复制以下的curl命令:', curlCommand);
            }
        }

        /**
         * 生成curl命令
         * 根据当前请求配置生成对应的curl命令字符串
         * @returns {string} 生成的curl命令
         */
        function generateCurlCommand() {
            try {
                const method = byId('httpMethod').value;
                const url = byId('url').value.trim();

                if (!url) {
                    alert('请输入URL');
                    return null;
                }

                let curlCommand = 'curl';

                if (method && method !== 'GET' && method !== 'WS' && method !== 'SSE') {
                    curlCommand += ` -X ${method}`;
                }

                const settings = getRequestSettings();
                const fullUrl = normalizeUrlWithProtocol(url, settings.default_protocol || 'http');

                const headers = {};
                docSelectAll('#headersList .header-row').forEach(row => {
                    const inputs = row.getElementsByTagName('input');
                    const isEnabled = inputs[0]?.checked;
                    const key = inputs[1]?.value?.trim();
                    const value = inputs[2]?.value?.trim();
                    if (isEnabled && key) {
                        headers[key] = value || '';
                    }
                });

                const globalHeaders = getGlobalHeaders();
                for (const [key, value] of Object.entries(globalHeaders)) {
                    if (!headers[key]) {
                        headers[key] = value;
                    }
                }

                for (const [key, value] of Object.entries(headers)) {
                    if (key && value !== undefined) {
                        curlCommand += ` -H "${key}: ${value.replace(/"/g, '\\"')}"`;
                    }
                }

                const bodyType = getBodyType();

                if (bodyType !== 'none' && bodyType !== 'websocket') {
                    switch (bodyType) {
                        case 'json': {
                            const selectedRow = document.querySelector('#jsonBodyRows input[type="radio"]:checked');
                            if (selectedRow) {
                                const jsonText = selectedRow.closest('.body-row').querySelector('textarea')?.value || '';
                                if (jsonText) {
                                    curlCommand += ` -d '${jsonText.replace(/'/g, "'\\''")}' -H "Content-Type: application/json"`;
                                }
                            }
                            break;
                        }
                        case 'text': {
                            const selectedRow = document.querySelector('#textBodyRows input[type="radio"]:checked');
                            if (selectedRow) {
                                const textContent = selectedRow.closest('.body-row').querySelector('textarea')?.value || '';
                                if (textContent) {
                                    curlCommand += ` -d '${textContent.replace(/'/g, "'\\''")}' -H "Content-Type: text/plain"`;
                                }
                            }
                            break;
                        }
                        case 'form': {
                            const formData = [];
                            docSelectAll('#formRows .header-row').forEach(row => {
                                const inputs = row.getElementsByTagName('input');
                                const isEnabled = inputs[0]?.checked;
                                const key = inputs[1]?.value?.trim();
                                const value = inputs[2]?.value || '';
                                if (isEnabled && key) {
                                    formData.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
                                }
                            });
                            if (formData.length > 0) {
                                curlCommand += ` -d '${formData.join('&')}' -H "Content-Type: application/x-www-form-urlencoded"`;
                            }
                            break;
                        }
                        case 'formdata': {
                            docSelectAll('.formdata-row').forEach(row => {
                                const isEnabled = row.querySelector('input[type="checkbox"]')?.checked;
                                if (!isEnabled) return;

                                const key = row.querySelector('.formdata-key')?.value?.trim();
                                const type = row.querySelector('.formdata-type')?.value;

                                if (!key) return;

                                if (type === 'text') {
                                    const value = row.querySelector('.text-input')?.value || '';
                                    curlCommand += ` -F "${key}=${value.replace(/"/g, '\\"')}"`;
                                } else if (type === 'file') {
                                    const fileInput = row.querySelector('.file-input');
                                    if (fileInput?.files.length > 0) {
                                        for (const file of fileInput.files) {
                                            curlCommand += ` -F "${key}=@${file.name}"`;
                                        }
                                    }
                                }
                            });
                            break;
                        }
                        case 'binary': {
                            const selectedRow = document.querySelector('#binaryBodyRows input[type="radio"]:checked');
                            if (selectedRow) {
                                const fileInput = selectedRow.closest('.body-row').querySelector('input[type="file"]');
                                if (fileInput?.files.length > 0) {
                                    const fileName = fileInput.files[0].name;
                                    curlCommand += ` --data-binary "@${fileName}" -H "Content-Type: application/octet-stream"`;
                                }
                            }
                            break;
                        }
                    }
                }

                if (settings.verify_ssl === 'N') {
                    curlCommand += ' -k';
                }

                if (settings.follow_redirect === 'Y') {
                    curlCommand += ' -L';
                }

                if (settings.timeout && parseInt(settings.timeout) > 0) {
                    curlCommand += ` --max-time ${settings.timeout}`;
                }

                curlCommand += ` "${fullUrl}"`;

                return curlCommand;

            } catch (error) {
                alert('导出curl命令失败: ' + error.message);
                console.error('导出curl命令错误:', error);
                return null;
            }
        }

        /**
         * 将curl命令导出到文本框
         * 生成curl命令并显示在导出文本框中
         */
        function exportCurlToTextarea() {
            const curlCommand = generateCurlCommand();
            if (curlCommand) {
                byId('curlExportArea').value = curlCommand;
            }
        }

        /**
         * 复制curl命令到剪贴板
         * 从导出文本框复制curl命令
         */
        function copyCurlExport() {
            const curlExportArea = byId('curlExportArea');
            const curlCommand = curlExportArea.value;
            if (!curlCommand) {
                alert('请先生成curl命令');
                return;
            }

            try {
                if (typeof navigator !== 'undefined' && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    navigator.clipboard.writeText(curlCommand).then(() => {
                        alert('已复制到剪贴板！');
                    }).catch(() => {
                        curlExportArea.select();
                        document.execCommand('copy');
                        alert('已复制到剪贴板！');
                    });
                } else {
                    curlExportArea.select();
                    document.execCommand('copy');
                    alert('已复制到剪贴板！');
                }
            } catch (e) {
                curlExportArea.select();
                document.execCommand('copy');
                alert('已复制到剪贴板！');
            }
        }

        /**
         * 从文本框导入curl命令
         * 读取文本框中的curl命令并解析填充到请求表单
         */
        function importCurlFromTextarea() {
            const curlText = byId('curlImportArea').value.trim();
            if (!curlText) {
                alert('请输入curl命令');
                return;
            }
            importCurlFromText(curlText);
        }

        /**
         * 从文本解析curl命令并填充请求表单
         * @param {string} curlText - curl命令文本
         */
        function importCurlFromText(curlText) {
            try {
                const parsed = parseCurlCommand(curlText);
                console.log('Parsed curl command:', parsed);

                if (parsed.method) {
                    byId('httpMethod').value = parsed.method;
                    console.log('Set method:', parsed.method);
                }

                if (parsed.url) {
                    byId('url').value = parsed.url;
                    console.log('Set URL:', parsed.url);
                }

                // 清空现有请求头
                byId('headersList').innerHTML = '';

                // 添加请求头
                if (parsed.headers && Object.keys(parsed.headers).length > 0) {
                    console.log('Adding headers:', parsed.headers);
                    for (const [key, value] of Object.entries(parsed.headers)) {
                        const headerRow = document.createElement('div');
                        headerRow.className = 'header-row';
                        headerRow.innerHTML = `
                            <input type="checkbox" checked>
                            <input type="text" placeholder="Header名称" value="${key.replace(/"/g, '&quot;')}" />
                            <input type="text" placeholder="Header值" value="${value.replace(/"/g, '&quot;')}" />
                            <input type="text" placeholder="备注" class="header-remark input-remark" />
                            <button class="remove-btn" onclick="removeHeader(this)">删除</button>
                        `;
                        byId('headersList').appendChild(headerRow);
                    }
                } else {
                    console.log('No headers, adding default row');
                    // 添加一个默认空行
                    addHeader();
                }

                // 处理请求体
                console.log('Body type:', parsed.bodyType);
                if (parsed.bodyType === 'json' && parsed.body) {
                    // 设置JSON请求体
                    document.querySelector('input[name="bodyType"][value="json"]').checked = true;
                    updateBodyType('json');
                    const jsonBodyRows = byId('jsonBodyRows');
                    jsonBodyRows.innerHTML = '';
                    const row = createJsonBodyRow();
                    row.querySelector('textarea').value = parsed.body;
                    row.querySelector('input[type="radio"]').checked = true;
                    jsonBodyRows.appendChild(row);
                } else if (parsed.bodyType === 'text' && parsed.body) {
                    // 设置Text请求体
                    document.querySelector('input[name="bodyType"][value="text"]').checked = true;
                    updateBodyType('text');
                    const textBodyRows = byId('textBodyRows');
                    textBodyRows.innerHTML = '';
                    const row = createTextBodyRow();
                    row.querySelector('textarea').value = parsed.body;
                    row.querySelector('input[type="radio"]').checked = true;
                    textBodyRows.appendChild(row);
                } else if (parsed.bodyType === 'form' && parsed.body) {
                    // 设置Form请求体
                    document.querySelector('input[name="bodyType"][value="form"]').checked = true;
                    updateBodyType('form');
                    byId('formRows').innerHTML = '';

                    // 解析form数据
                    const params = new URLSearchParams(parsed.body);
                    let hasFormData = false;
                    for (const [key, value] of params.entries()) {
                        hasFormData = true;
                        const formRow = document.createElement('div');
                        formRow.className = 'header-row';
                        formRow.innerHTML = `
                            <input type="checkbox" checked>
                            <input type="text" placeholder="参数名称" value="${key.replace(/"/g, '&quot;')}"/>
                            <input type="text" placeholder="参数值" value="${value.replace(/"/g, '&quot;')}"/>
                            <input type="text" placeholder="备注" class="form-remark input-remark"/>
                            <button class="remove-btn" onclick="removeFormRow(this)">删除</button>
                        `;
                        byId('formRows').appendChild(formRow);
                    }
                    // 如果没有解析到任何form数据，添加一个空行
                    if (!hasFormData) {
                        addFormRow();
                    }
                } else if (parsed.bodyType === 'formdata' && parsed.formFields) {
                    // 设置FormData请求体
                    document.querySelector('input[name="bodyType"][value="formdata"]').checked = true;
                    updateBodyType('formdata');
                    byId('formDataRows').innerHTML = '';

                    for (const field of parsed.formFields) {
                        const row = createFormDataRow();
                        row.querySelector('.formdata-key').value = field.name;
                        if (field.isFile) {
                            row.querySelector('.formdata-type').value = 'file';
                            handleTypeChange(row.querySelector('.formdata-type'));
                            // 文件类型，显示文件名提示
                            row.querySelector('.file-preview').innerHTML = `<div class="file-preview-item"><span>文件: ${field.value}</span></div>`;
                        } else {
                            row.querySelector('.formdata-type').value = 'text';
                            row.querySelector('.text-input').value = field.value;
                        }
                        byId('formDataRows').appendChild(row);
                    }
                    // 如果formFields为空，添加一个默认行
                    if (parsed.formFields.length === 0) {
                        addFormDataRow();
                    }
                } else {
                    // 无请求体
                    document.querySelector('input[name="bodyType"][value="none"]').checked = true;
                    updateBodyType('none');
                }

                alert('导入curl命令成功！');
            } catch (error) {
                alert('解析curl命令失败: ' + error.message);
                console.error('解析curl命令错误:', error);
            }
        }

        /**
         * 解析curl命令
         * @param {string} curlCommand - curl命令字符串
         * @returns {Object} 解析后的请求对象
         */
        function parseCurlCommand(curlCommand) {
            const result = {
                method: '', // 不设置默认值，后面根据是否有数据自动判断
                url: '',
                headers: {},
                bodyType: 'none',
                body: '',
                formFields: []
            };

            // 删除多余的空格和换行符
            let cmd = curlCommand.replace(/\\\n/g, ' ').replace(/\s+/g, ' ').trim();

            // 删除curl命令前缀
            cmd = cmd.replace(/^curl\s+/i, '');

            // 使用正则表达式匹配参数
            const patterns = {
                // 支持 -X 和 --request
                method: /(?:-X|--request)\s+([A-Z]+)/i,
                // 支持 --url
                urlParam: /--url\s+['"]([^'"]+)['"]/,
                // 支持 -H 和 --header
                header: /(?:-H|--header)\s+['"]([^'"]+)['"]/g,
                data: /-d\s+([^\s]+)/g,
                dataRaw: /--data-raw\s+([^\s]+)/g,
                // 支持 -F 和 --form
                form: /(?:-F|--form)\s+['"]([^'"]+)['"]/g,
                dataBinary: /--data-binary\s+['"]@?([^'"]+)['"]/,
                // 支持 --cookie
                cookie: /--cookie\s+['"]([^'"]+)['"]/,
                insecure: /-k|--insecure/,
                location: /-L|--location/,
                maxTime: /--max-time\s+(\d+)/,
            };

            // 提取请求方法
            const methodMatch = cmd.match(patterns.method);
            if (methodMatch) {
                result.method = methodMatch[1].toUpperCase();
            }

            // 提取URL（优先使用 --url 参数）
            const urlParamMatch = cmd.match(patterns.urlParam);
            if (urlParamMatch) {
                result.url = urlParamMatch[1];
            }

            // 提取请求头
            let match;
            while ((match = patterns.header.exec(cmd)) !== null) {
                const headerLine = match[1];
                const colonIndex = headerLine.indexOf(':');
                if (colonIndex > 0) {
                    const key = headerLine.substring(0, colonIndex).trim();
                    const value = headerLine.substring(colonIndex + 1).trim();
                    result.headers[key] = value;
                }
            }

            // 处理 --cookie 和 -b 参数
            const cookieMatch = cmd.match(patterns.cookie);
            if (cookieMatch) {
                result.headers['Cookie'] = cookieMatch[1];
            } else {
                // 尝试匹配 -b 参数（短格式）
                const bMatch = cmd.match(/-b\s+['"]([^'"]+)['"]/);
                if (bMatch) {
                    result.headers['Cookie'] = bMatch[1];
                }
            }

            // 提取请求体数据 (--data-raw 优先)
            let hasData = false;

            // 首先尝试匹配带引号的完整数据
            let dataRawMatch = cmd.match(/--data-raw\s+(['"])([\s\S]*?)\1/);
            if (dataRawMatch) {
                result.body = dataRawMatch[2].replace(/\\'/g, "'").replace(/\\"/g, '"');
                hasData = true;
            } else {
                // 尝试匹配不带引号的数据
                dataRawMatch = cmd.match(/--data-raw\s+([^\s]+)/);
                if (dataRawMatch) {
                    result.body = dataRawMatch[1];
                    hasData = true;
                }
            }

            // 如果没有 --data-raw，尝试 -d 或 --data
            if (!hasData) {
                let dataMatch = cmd.match(/-d\s+(['"])([\s\S]*?)\1/);
                if (dataMatch) {
                    result.body = dataMatch[2].replace(/\\'/g, "'").replace(/\\"/g, '"');
                    hasData = true;
                } else {
                    dataMatch = cmd.match(/-d\s+([^\s]+)/);
                    if (dataMatch) {
                        result.body = dataMatch[1];
                        hasData = true;
                    }
                }
            }

            // 提取form-data数据 (-F 或 --form)
            const formFields = [];
            while ((match = patterns.form.exec(cmd)) !== null) {
                const field = match[1];
                const equalIndex = field.indexOf('=');
                if (equalIndex > 0) {
                    const name = field.substring(0, equalIndex).trim();
                    const value = field.substring(equalIndex + 1).trim();
                    const isFile = value.startsWith('@');
                    formFields.push({
                        name: name,
                        value: isFile ? value.substring(1) : value,
                        isFile: isFile
                    });
                }
            }

            if (formFields.length > 0) {
                result.bodyType = 'formdata';
                result.formFields = formFields;
            } else if (hasData) {
                // 根据Content-Type判断请求体类型
                const contentType = result.headers['Content-Type'] || result.headers['content-type'] || '';
                if (contentType.includes('application/json')) {
                    result.bodyType = 'json';
                } else if (contentType.includes('application/x-www-form-urlencoded')) {
                    result.bodyType = 'form';
                } else if (contentType.includes('text/')) {
                    result.bodyType = 'text';
                } else if (result.body) {
                    // 尝试解析JSON
                    try {
                        JSON.parse(result.body);
                        result.bodyType = 'json';
                    } catch (e) {
                        // 如果不是JSON，默认为text
                        result.bodyType = 'text';
                    }
                }
            }

            // 如果还没有提取到URL，尝试从命令中提取
            if (!result.url) {
                // 先尝试匹配带引号的URL（可能在命令开头或任何位置）
                let urlMatch = cmd.match(/['"]([^'"\s]+)['"]/);
                if (urlMatch && (urlMatch[1].startsWith('http://') || urlMatch[1].startsWith('https://') || urlMatch[1].includes('/'))) {
                    result.url = urlMatch[1];
                } else {
                    // 尝试匹配不带引号的URL（在命令开头，不以-开头的参数）
                    urlMatch = cmd.match(/^([^\s-][^\s]*)/);
                    if (urlMatch && (urlMatch[1].startsWith('http://') || urlMatch[1].startsWith('https://') || urlMatch[1].includes('/'))) {
                        result.url = urlMatch[1];
                    }
                }
            }

            // 如果有 --data-raw 或 -d 参数，且没有明确指定方法，默认为 POST
            if (!result.method && (hasData || formFields.length > 0)) {
                result.method = 'POST';
            }

            // 如果还是没有方法，默认为 GET
            if (!result.method) {
                result.method = 'GET';
            }

            return result;
        }

        /**
         * 页面初始化
         * 在DOM加载完成后执行所有初始化操作
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 并行初始化所有组件
                await Promise.all([
                    addFormDataRow(),
                    addFormRow(),
                    loadGlobalHeaders(),
                    updateHistoryDisplay(),
                    updateApisDisplay(),
                    loadVariables(),
                    initUseProxy(),
                    updateApiCollectionSelect()
                ]);

                // 恢复上次选中的标签页
                const lastActiveTab = StorageManager.get('lastActiveTab', 'history');
                switchPanelTab(lastActiveTab);
            } catch (error) {
                console.error('页面初始化失败:', error);
            }
        });

    </script>
</body>

</html>